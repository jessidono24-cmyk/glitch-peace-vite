<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GLITCHÂ·PEACE v5 COMPLETE</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body {
  background:#02020a;
  display:flex; align-items:center; justify-content:center;
  min-height:100vh;
  font-family:'Courier New',monospace;
  overflow:hidden; user-select:none;
}
canvas {
  display:block;
  border:1px solid rgba(255,255,255,0.07);
  border-radius:8px;
  box-shadow:0 0 80px rgba(0,255,136,0.06), 0 0 200px rgba(0,0,0,0.9);
  image-rendering:pixelated;
}
#mobile-controls {
  display:none; position:fixed; bottom:24px; left:50%;
  transform:translateX(-50%); gap:6px; flex-direction:column;
  align-items:center; z-index:10;
}
#mobile-controls .row { display:flex; gap:6px; }
.dpad {
  width:52px; height:52px;
  background:rgba(0,255,136,0.08);
  border:1px solid rgba(0,255,136,0.25);
  border-radius:6px; color:#00ff88; font-size:20px; cursor:pointer;
  display:flex; align-items:center; justify-content:center;
  -webkit-tap-highlight-color:transparent; transition:background 0.1s;
}
.dpad:active { background:rgba(0,255,136,0.25); }
@media (max-width:700px) { #mobile-controls { display:flex; } }
</style>
</head>
<body>
<canvas id="c"></canvas>
<div id="mobile-controls">
  <div class="row"><button class="dpad" id="btn-up">â†‘</button></div>
  <div class="row">
    <button class="dpad" id="btn-left">â†</button>
    <button class="dpad" id="btn-down">â†“</button>
    <button class="dpad" id="btn-right">â†’</button>
  </div>
</div>
<script>
'use strict';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TILE TYPES  (data-driven)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const T = {
  VOID:0, DESPAIR:1, TERROR:2, SELF_HARM:3, PEACE:4, WALL:5,
  INSIGHT:6, HIDDEN:7, RAGE:8, HOPELESS:9, GLITCH:10,
  ARCHETYPE:11,  // Dragon / Child / Orb overlays
  TELEPORT:12,   // Leaping Field mechanic
  COVER:13,      // Modern Bedroom â€” cover tile
  TRAP:14,       // Aztec labyrinth
  MEMORY:15,     // Ghost tile from prior dreamscape
  PAIN:16,       // Residual pain left by SELF_HARM
};

// Tile data: damage, spread, pushback, color/glow, symbol, effect
const TILE_DEF = {
  [T.VOID]:     {dmg:0,  spread:false, push:0,  bg:'#06060f', bd:'rgba(255,255,255,0.04)', glow:null,      sym:''},
  [T.DESPAIR]:  {dmg:8,  spread:true,  push:0,  bg:'#0d0d55', bd:'#1a1aff', glow:'#2233ff', sym:'â†“'},
  [T.TERROR]:   {dmg:20, spread:false, push:0,  bg:'#500000', bd:'#cc1111', glow:'#ff2222', sym:'!'},
  [T.SELF_HARM]:{dmg:14, spread:false, push:0,  bg:'#360000', bd:'#880000', glow:'#aa0000', sym:'âœ•'},
  [T.PEACE]:    {dmg:0,  spread:false, push:0,  bg:'#002810', bd:'#00ff88', glow:'#00ffcc', sym:'â—ˆ'},
  [T.WALL]:     {dmg:0,  spread:false, push:0,  bg:'#0e0e18', bd:'#252535', glow:null,      sym:''},
  [T.INSIGHT]:  {dmg:0,  spread:false, push:0,  bg:'#001a18', bd:'#00ddbb', glow:'#00ffee', sym:'â—†'},
  [T.HIDDEN]:   {dmg:0,  spread:false, push:0,  bg:'#04040a', bd:'rgba(0,200,100,0.08)', glow:null, sym:''},
  [T.RAGE]:     {dmg:18, spread:false, push:2,  bg:'#3a0010', bd:'#cc0044', glow:'#ff0066', sym:'â–²'},
  [T.HOPELESS]: {dmg:12, spread:true,  push:0,  bg:'#002040', bd:'#0044cc', glow:'#0066ff', sym:'~'},
  [T.GLITCH]:   {dmg:5,  spread:false, push:0,  bg:'#1a0a1a', bd:'#aa00ff', glow:'#dd00ff', sym:'?'},
  [T.ARCHETYPE]:{dmg:0,  spread:false, push:0,  bg:'#0a1a0a', bd:'#ffdd00', glow:'#ffee44', sym:'â˜†'},
  [T.TELEPORT]: {dmg:0,  spread:false, push:0,  bg:'#001820', bd:'#00aaff', glow:'#00ccff', sym:'â‡’'},
  [T.COVER]:    {dmg:0,  spread:false, push:0,  bg:'#101018', bd:'#446688', glow:null,      sym:'â–ª'},
  [T.TRAP]:     {dmg:16, spread:false, push:1,  bg:'#1a0800', bd:'#cc6600', glow:'#ff8800', sym:'Ã—'},
  [T.MEMORY]:   {dmg:0,  spread:false, push:0,  bg:'#06060a', bd:'rgba(100,200,150,0.2)', glow:null, sym:'Â·'},
  [T.PAIN]:     {dmg:6,  spread:false, push:0,  bg:'#200808', bd:'#661111', glow:'#880000', sym:'Â·'},
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ğŸ® ULTIMATE PLAY MODES SYSTEM - 13 Different Gameplay Experiences
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PLAY_MODES = {
  classic: { name:'Classic Arcade', peace:1.0, haz:1.0, ins:1.0, score:1.2, eSpd:1.0, vision:999, moves:999, special:null },
  zen: { name:'Zen Garden', peace:1.5, haz:0.0, ins:2.0, score:0.5, eSpd:0.0, vision:999, moves:999, special:'noEnemies' },
  speedrun: { name:'Speedrun', peace:0.8, haz:1.2, ins:0.5, score:2.0, eSpd:1.3, vision:999, moves:999, special:'timer' },
  puzzle: { name:'Puzzle Master', peace:1.0, haz:0.8, ins:1.5, score:1.5, eSpd:0.0, vision:999, moves:50, special:'moveLimit' },
  horror: { name:'Survival Horror', peace:0.5, haz:1.5, ins:0.8, score:3.0, eSpd:0.8, vision:4, moves:999, special:'permadeath' },
  roguelike: { name:'Roguelike', peace:0.7, haz:1.3, ins:1.2, score:1.0, eSpd:1.1, vision:999, moves:999, special:'randomGrid' },
  recovery: { name:'Pattern Training', peace:1.3, haz:0.7, ins:1.5, score:0.8, eSpd:0.7, vision:999, moves:999, special:'recoveryTools' },
  bossrush: { name:'Boss Rush', peace:2.0, haz:0.5, ins:3.0, score:5.0, eSpd:1.5, vision:999, moves:999, special:'bossOnly' },
  pacifist: { name:'Pacifist Path', peace:1.5, haz:0.3, ins:2.0, score:2.0, eSpd:1.2, vision:999, moves:999, special:'noCombat' },
  reverse: { name:'Reverse Polarity', peace:1.0, haz:1.0, ins:1.0, score:1.5, eSpd:1.0, vision:999, moves:999, special:'reversed' },
  ritual: { name:'Ritual Practice', peace:1.0, haz:1.0, ins:1.5, score:1.0, eSpd:0.5, vision:999, moves:999, special:'slowmo' },
  explorer: { name:'Explorer Mode', peace:0.9, haz:0.9, ins:1.6, score:1.0, eSpd:0.9, vision:999, moves:999, special:'moreInsight' },
  daily: { name:'Daily Challenge', peace:1.0, haz:1.0, ins:1.0, score:1.0, eSpd:1.0, vision:999, moves:999, special:'daily' },
};
let currentMode = 'classic';
function applyPlayMode(game, mode) {
  const m = PLAY_MODES[mode] || PLAY_MODES.classic;
  game.peaceMul = m.peace;
  game.hazMul = m.haz;
  game.insMul = m.ins;
  game.scoreMul = m.score;
  game.enemySpeedMul = m.eSpd;
  game.visionRadius = m.vision;
  game.moveLimit = m.moves;
  game.modeSpecial = m.special;
  return game;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DREAMSCAPE DEFINITIONS  (modular level templates)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DREAMSCAPES = [
  {
    id:'void',
    name:'VOID STATE',
    subtitle:'raw survival Â· awakening',
    matrixDefault:'B',
    bgColor:'#03030a', bgAccent:'#001a0a',
    emotion:'numbness',
    archetype:null,
    hazardSet:[T.DESPAIR, T.TERROR, T.SELF_HARM],
    hazardCounts:[8,5,4],
    specialTiles:[],
    enemyBehavior:'wander',
    enemyCount:3,
    environmentEvent:null,
    narrative:'the void holds youâ€¦ begin',
    completionText:'you surfaced from the voidâ€¦',
  },
  {
    id:'mountain_dragon',
    name:'MOUNTAIN DRAGON REALM',
    subtitle:'initiation Â· fear Â· guardian presence',
    matrixDefault:'B',
    bgColor:'#020508', bgAccent:'#0a0518',
    emotion:'fear',
    archetype:'dragon',
    hazardSet:[T.DESPAIR, T.TERROR, T.HOPELESS],
    hazardCounts:[6,5,4],
    specialTiles:[T.ARCHETYPE],
    enemyBehavior:'patrol',
    enemyCount:4,
    environmentEvent:'gravity_shift',
    narrative:'the dragon watchesâ€¦ do not falter',
    completionText:'dragon acknowledged your courageâ€¦',
  },
  {
    id:'courtyard',
    name:'MOUNTAIN COURTYARD OF OJOS',
    subtitle:'loop Â· language puzzles Â· captor-teacher',
    matrixDefault:'A',
    bgColor:'#080502', bgAccent:'#180a00',
    emotion:'frustration',
    archetype:'captor',
    hazardSet:[T.RAGE, T.DESPAIR, T.GLITCH],
    hazardCounts:[5,6,5],
    specialTiles:[T.TRAP, T.ARCHETYPE],
    enemyBehavior:'patrol',
    enemyCount:4,
    environmentEvent:'loop_reset',
    narrative:'the courtyard repeatsâ€¦ find the door',
    completionText:'you escaped the captor\'s loopâ€¦ empathy found',
  },
  {
    id:'leaping_field',
    name:'LEAPING FIELD',
    subtitle:'mobility Â· orb-sheep guide Â· vulnerability',
    matrixDefault:'B',
    bgColor:'#020a06', bgAccent:'#002210',
    emotion:'vulnerability',
    archetype:'orb',
    hazardSet:[T.TERROR, T.SELF_HARM, T.HOPELESS],
    hazardCounts:[4,3,5],
    specialTiles:[T.TELEPORT, T.ARCHETYPE],
    enemyBehavior:'orbit',
    enemyCount:3,
    environmentEvent:'glide_nodes',
    narrative:'the orb drifts aheadâ€¦ follow',
    completionText:'you leapt where fear said stayâ€¦',
  },
  {
    id:'summit',
    name:'MOUNTAIN SUMMIT REALM',
    subtitle:'high stakes Â· multi-plane Â· dragon guardian',
    matrixDefault:'B',
    bgColor:'#04050a', bgAccent:'#080418',
    emotion:'exhaustion',
    archetype:'dragon',
    hazardSet:[T.TERROR, T.RAGE, T.HOPELESS, T.SELF_HARM],
    hazardCounts:[5,4,5,3],
    specialTiles:[T.ARCHETYPE, T.HIDDEN],
    enemyBehavior:'adaptive',
    enemyCount:5,
    environmentEvent:'line_of_sight',
    narrative:'the summit demands everythingâ€¦',
    completionText:'from the peak, the path below is clearâ€¦',
  },
  {
    id:'neighborhood',
    name:'CHILDHOOD NEIGHBORHOOD',
    subtitle:'pursuit Â· panic Â· early hazard',
    matrixDefault:'A',
    bgColor:'#080408', bgAccent:'#150510',
    emotion:'panic',
    archetype:null,
    hazardSet:[T.DESPAIR, T.TERROR, T.SELF_HARM, T.PAIN],
    hazardCounts:[7,6,4,3],
    specialTiles:[T.MEMORY],
    enemyBehavior:'chase_fast',
    enemyCount:5,
    environmentEvent:'capture_zones',
    narrative:'they are closeâ€¦ run',
    completionText:'you outran the pursuing shadowâ€¦',
  },
  {
    id:'bedroom',
    name:'MODERN BEDROOM GUNFIGHT',
    subtitle:'reflex Â· cover Â· sudden chaos',
    matrixDefault:'A',
    bgColor:'#050508', bgAccent:'#0a0a18',
    emotion:'chaos',
    archetype:'protector',
    hazardSet:[T.TERROR, T.RAGE, T.GLITCH],
    hazardCounts:[6,5,4],
    specialTiles:[T.COVER, T.ARCHETYPE],
    enemyBehavior:'rush',
    enemyCount:6,
    environmentEvent:'rapid_spawn',
    narrative:'chaos eruptsâ€¦ find cover',
    completionText:'protector stood firmâ€¦ chaos receded',
  },
  {
    id:'aztec',
    name:'AZTEC / MAYAN CHASE',
    subtitle:'labyrinth Â· traps Â· captor-teacher',
    matrixDefault:'A',
    bgColor:'#080400', bgAccent:'#1a0800',
    emotion:'anxiety',
    archetype:'captor',
    hazardSet:[T.TRAP, T.RAGE, T.DESPAIR, T.TERROR],
    hazardCounts:[6,4,5,4],
    specialTiles:[T.TRAP, T.ARCHETYPE],
    enemyBehavior:'labyrinth',
    enemyCount:4,
    environmentEvent:'dead_ends',
    narrative:'the stone corridors close inâ€¦',
    completionText:'you traced the ancient pathâ€¦ free',
  },
  {
    id:'orb_escape',
    name:'ORB ESCAPE EVENT',
    subtitle:'flight Â· wall-phase Â· fleeting hope',
    matrixDefault:'B',
    bgColor:'#010a08', bgAccent:'#002018',
    emotion:'hope',
    archetype:'orb',
    hazardSet:[T.HOPELESS, T.DESPAIR, T.GLITCH],
    hazardCounts:[4,4,4],
    specialTiles:[T.TELEPORT, T.ARCHETYPE, T.INSIGHT],
    enemyBehavior:'scatter',
    enemyCount:3,
    environmentEvent:'wall_phase',
    narrative:'the orb leads through the membraneâ€¦',
    completionText:'you passed throughâ€¦ the other side holds',
  },
  {
    id:'integration',
    name:'DREAMSCAPE INTEGRATION',
    subtitle:'all matrices Â· sovereignty Â· final emergence',
    matrixDefault:'B',
    bgColor:'#020208', bgAccent:'#080418',
    emotion:'integration',
    archetype:'all',
    hazardSet:[T.DESPAIR,T.TERROR,T.RAGE,T.HOPELESS,T.SELF_HARM,T.GLITCH,T.TRAP],
    hazardCounts:[5,4,4,4,3,3,3],
    specialTiles:[T.ARCHETYPE, T.TELEPORT, T.INSIGHT, T.HIDDEN],
    enemyBehavior:'predictive',
    enemyCount:7,
    environmentEvent:'mashup',
    narrative:'all dreamscapes convergeâ€¦ integrate',
    completionText:'SA Â· MCA Â· MNF Â· SC â€” the sovereignty is yours',
  },
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ARCHETYPE DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ARCHETYPES = {
  dragon: {
    name:'DRAGON',
    color:'#ffaa00', glow:'#ff8800',
    power:'wall_jump',     // jump 2 tiles
    powerDesc:'DRAGON LEAP â€” jump 2 tiles (J)',
    activationMsg:'Dragon grants you passageâ€¦',
    completionBonus:'dragon protection persistsâ€¦',
  },
  child: {
    name:'CHILD GUIDE',
    color:'#aaffcc', glow:'#00ffaa',
    power:'reveal',        // reveal hidden nodes
    powerDesc:'CHILD SIGHT â€” hidden nodes revealed',
    activationMsg:'Child guide illuminates the pathâ€¦',
    completionBonus:'child\'s sight lingersâ€¦',
  },
  orb: {
    name:'ORB / SHEEP',
    color:'#aaddff', glow:'#00ccff',
    power:'phase_walk',    // pass through walls briefly
    powerDesc:'ORB PHASE â€” walk through walls (J)',
    activationMsg:'Orb opens the membraneâ€¦',
    completionBonus:'orb carries you forwardâ€¦',
  },
  captor: {
    name:'CAPTOR-TEACHER',
    color:'#ffaadd', glow:'#dd0088',
    power:'rewind',        // temporal rewind 3 moves
    powerDesc:'REWIND â€” undo last 3 moves (J)',
    activationMsg:'Captor shows you the loopâ€¦',
    completionBonus:'you learned from the captorâ€¦',
  },
  protector: {
    name:'PROTECTOR',
    color:'#88ccff', glow:'#4488ff',
    power:'shield_burst',  // burst shield + stun enemies
    powerDesc:'PROTECT â€” shield burst (J)',
    activationMsg:'Protector stands betweenâ€¦',
    completionBonus:'protection enduresâ€¦',
  },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIG & SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CELL=44, GAP=2;
const GRID_SIZES={small:10,medium:13,large:17};
const DIFF_CFG={
  easy:  {eSpeedBase:950,eSpeedMin:350,dmgMul:0.55,hazMul:0.7},
  normal:{eSpeedBase:720,eSpeedMin:210,dmgMul:1.0, hazMul:1.0},
  hard:  {eSpeedBase:520,eSpeedMin:150,dmgMul:1.45,hazMul:1.35},
};

let CFG={gridSize:'medium',difficulty:'normal',particles:true,dreamIdx:0};
function SZ()   {return GRID_SIZES[CFG.gridSize];}
function DIFF() {return DIFF_CFG[CFG.difficulty];}
function GP()   {return SZ()*CELL+(SZ()-1)*GAP;}
function CW()   {return GP()+48;}
function CH()   {return GP()+148;}

const canvas=document.getElementById('c');
const ctx=canvas.getContext('2d');
const DPR=Math.min(window.devicePixelRatio||1,2);

function resizeCanvas(){
  const w=CW(),h=CH();
  canvas.width=w*DPR; canvas.height=h*DPR;
  canvas.style.width=Math.min(w,window.innerWidth-16)+'px';
  canvas.style.height='auto';
  ctx.setTransform(1,0,0,1,0,0);
  ctx.scale(DPR,DPR);
}
resizeCanvas();

// â”€â”€ Matrix palettes (extended for all tile types) â”€â”€
function makePal(shifts){
  const p={};
  for(const [id,def] of Object.entries(TILE_DEF)){
    p[id]={bg:def.bg, bd:def.bd, glow:def.glow};
  }
  if(shifts) for(const [id,ov] of Object.entries(shifts)) Object.assign(p[id],ov);
  return p;
}
const PAL_B=makePal(null);
const PAL_A=makePal({
  [T.VOID]:    {bg:'#0a0208',bd:'rgba(180,30,60,0.05)'},
  [T.DESPAIR]: {bg:'#220011',bd:'#aa0044',glow:'#dd1155'},
  [T.TERROR]:  {bg:'#600010',bd:'#ee0022',glow:'#ff3333'},
  [T.SELF_HARM]:{bg:'#440008',bd:'#aa0011',glow:'#cc0022'},
  [T.PEACE]:   {bg:'#001408',bd:'#00aa44',glow:'#00dd66'},
  [T.INSIGHT]: {bg:'#000a18',bd:'#0088cc',glow:'#00aaff'},
  [T.RAGE]:    {bg:'#500008',bd:'#ee1133',glow:'#ff2244'},
  [T.HOPELESS]:{bg:'#001025',bd:'#0033aa',glow:'#0055dd'},
  [T.GLITCH]:  {bg:'#1a0028',bd:'#cc00ff',glow:'#ff00ff'},
});
function PAL(){return matrixActive==='A'?PAL_A:PAL_B;}

// Dreamscape-specific palette tints applied over base
function dreamPal(ds,tid){
  const base=PAL()[tid]||PAL()[T.VOID];
  return base;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let game, phase='title', animId, prevTs=0;
let keys=new Set(), lastMove=0;
let matrixActive='B';
let matrixHoldTime=0;
let highScores=[], sessionRep=0, insightTokens=0;
let dreamHistory=[]; // completed dreamscapes this run
let memoryEchoes=[]; // ghost tiles from prior dreamscapes

// â”€â”€ Upgrades / powers â”€â”€
const UPG={
  maxHp:100, moveDelay:120,
  magnet:false, shield:false, shieldTimer:0, shieldCount:0,
  energyMax:100, energy:100,
  aura:false, freeze:false, freezeTimer:0,
  particleColor:'#00ff88',
  // Archetype powers
  archetypePower:null,    // current unlocked power
  archetypeDuration:0,
  phaseShift:false,       // walk through hazards
  phaseTimer:0,
  temporalRewind:false,   // rewind last 3 moves
  rewindBuffer:[],        // [{y,x,grid snapshot}]
  glitchPulse:false,      // charge via peace streaks
  glitchPulseCharge:0,
  resonanceMultiplier:1,  // consecutive peace combo
  comboCount:0,
  // Emotional state (modifies gameplay)
  emotion:'neutral',      // affects movement/visual
  emotionTimer:0,
};

function resetUpgrades(){
  Object.assign(UPG,{
    maxHp:100,moveDelay:120,magnet:false,shield:false,shieldTimer:0,shieldCount:0,
    energyMax:100,energy:100,aura:false,freeze:false,freezeTimer:0,
    particleColor:'#00ff88',archetypePower:null,archetypeDuration:0,
    phaseShift:false,phaseTimer:0,temporalRewind:false,rewindBuffer:[],
    glitchPulse:false,glitchPulseCharge:0,resonanceMultiplier:1,comboCount:0,
    emotion:'neutral',emotionTimer:0,
  });
}

// â”€â”€ Upgrade shop â”€â”€
const UPGRADE_SHOP=[
  {id:'maxhp',  name:'+MAX HP',       cost:3,desc:'max HP +25'},
  {id:'speed',  name:'+MOVE SPEED',   cost:2,desc:'faster movement'},
  {id:'magnet', name:'PEACE MAGNET',  cost:4,desc:'attract nearby â—ˆ'},
  {id:'freeze', name:'ENEMY FREEZE',  cost:5,desc:'Q: freeze all enemies'},
  {id:'aura',   name:'GLOW AURA',     cost:2,desc:'cosmetic pulse aura'},
  {id:'energy', name:'+ENERGY MAX',   cost:3,desc:'energy bar +30'},
  {id:'rewind', name:'TEMPORAL REWIND',cost:6,desc:'J: undo last 3 moves'},
  {id:'pulse',  name:'GLITCH PULSE',  cost:5,desc:'charged clear (R)'},
];
let shopIdx=0, upgradeFrom='title';

function checkOwned(id){
  const m={maxhp:UPG.maxHp>100,speed:UPG.moveDelay<120,magnet:UPG.magnet,
    freeze:UPG.freeze,aura:UPG.aura,energy:UPG.energyMax>100,
    rewind:UPG.temporalRewind,pulse:UPG.glitchPulse};
  return m[id]||false;
}
function buyUpgrade(id){
  const up=UPGRADE_SHOP.find(u=>u.id===id);
  if(!up||insightTokens<up.cost||checkOwned(id)) return;
  insightTokens-=up.cost;
  if(id==='maxhp'){UPG.maxHp+=25;if(game)game.hp=Math.min(game.hp+25,UPG.maxHp);}
  if(id==='speed') UPG.moveDelay=Math.max(55,UPG.moveDelay-15);
  if(id==='magnet') UPG.magnet=true;
  if(id==='freeze') UPG.freeze=true;
  if(id==='aura')   UPG.aura=true;
  if(id==='energy') UPG.energyMax=Math.min(200,UPG.energyMax+30);
  if(id==='rewind') UPG.temporalRewind=true;
  if(id==='pulse')  UPG.glitchPulse=true;
}

// â”€â”€ Menu state â”€â”€
const MAIN_MENU=['â–¶  START JOURNEY','SELECT DREAMSCAPE','ğŸ® PLAY MODE','OPTIONS','HIGH SCORES','UPGRADES'];
let menuIdx=0;
const OPT_GRID=['small','medium','large'];
const OPT_DIFF=['easy','normal','hard'];
let optIdx=0;
const PAUSE_MENU=['RESUME','OPTIONS','UPGRADES','QUIT TO TITLE'];
let pauseIdx=0;

// â”€â”€ Interlude â”€â”€
let interludeState={text:'',subtext:'',timer:0,ds:null};
// â”€â”€ Vision words â”€â”€
const VISION_WORDS=['memoryâ€¦','choiceâ€¦','echoâ€¦','voidâ€¦','selfâ€¦','signalâ€¦',
  'fragmentâ€¦','persistâ€¦','clarityâ€¦','dissolveâ€¦','boundaryâ€¦','witnessâ€¦',
  'anchorâ€¦','patternâ€¦','emergenceâ€¦','dragonâ€¦','guideâ€¦','orbâ€¦','fearâ€¦','hopeâ€¦'];
let visions=[];

// â”€â”€ Global effects â”€â”€
let glitchFrames=0, glitchTimer=500;
let anomalyActive=false, anomalyData={row:-1,col:-1,t:0};
let hallucinations=[];
let backgroundStars=[];
function initStars(w,h){
  backgroundStars=[];
  for(let i=0;i<30;i++) backgroundStars.push({x:Math.random()*w,y:Math.random()*h,
    r:0.5+Math.random()*1.5,a:Math.random()*0.15,phase:Math.random()*Math.PI*2});
}

function rnd(n){return Math.floor(Math.random()*n);}
function pick(arr){return arr[rnd(arr.length)];}
function clamp(v,a,b){return Math.max(a,Math.min(b,v));}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GRID GENERATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function makeGrid(sz){
  const g=Array.from({length:sz},()=>new Array(sz).fill(T.VOID));
  const walls=Math.floor(sz*sz*0.07);
  for(let i=0;i<walls;i++){
    const y=1+rnd(sz-2),x=1+rnd(sz-2);
    g[y][x]=T.WALL;
  }
  return g;
}

function spawnTile(grid,count,type,sz,avoidCorner){
  let n=0,itr=0;
  while(n<count&&itr<9999){itr++;
    const y=rnd(sz),x=rnd(sz);
    if(grid[y][x]===T.VOID){
      if(avoidCorner&&y<2&&x<2) continue;
      grid[y][x]=type;n++;
    }
  }
}

function buildDreamscape(ds,sz,level,prevScore,prevHp){
  const d=DIFF();
  const grid=makeGrid(sz);
  // Clear player spawn
  grid[0][0]=T.VOID;
  if(sz>1){grid[0][1]=T.VOID;grid[1][0]=T.VOID;}

  const peaceCount=4+Math.floor(level/2)+(sz-13);
  const insCount=1+Math.floor(level/3);

  // Spawn hazards from dreamscape definition
  ds.hazardSet.forEach((type,i)=>{
    const cnt=Math.round((ds.hazardCounts[i]||4)*d.hazMul);
    spawnTile(grid,cnt,type,sz,true);
  });
  spawnTile(grid,peaceCount,T.PEACE,sz,true);
  spawnTile(grid,insCount,T.INSIGHT,sz,true);

  // Special tiles
  ds.specialTiles.forEach(type=>{
    spawnTile(grid,2,type,sz,true);
  });

  // Memory echoes from previous dreamscapes
  if(dreamHistory.length>0){
    spawnTile(grid,3,T.MEMORY,sz,true);
  }

  // Labyrinth style: add extra walls for Aztec
  if(ds.id==='aztec'){
    for(let i=0;i<sz*2;i++){
      const y=1+rnd(sz-2),x=1+rnd(sz-2);
      if(grid[y][x]===T.VOID) grid[y][x]=T.WALL;
    }
  }

  // Enemy building
  const envEnemyBonus=ds.id==='bedroom'?2:ds.id==='summit'?1:0;
  const rawCount=Math.min(ds.enemyCount+Math.floor(level*0.5)+envEnemyBonus,10);
  const enemyCount=Math.max(1,rawCount+(CFG.difficulty==='hard'?2:CFG.difficulty==='easy'?-1:0));
  const enemies=[];
  const pad=Math.max(2,Math.floor(sz/5));
  for(let i=0;i<enemyCount;i++){
    let y,x,tr=0;
    do{y=pad+rnd(sz-pad*2);x=pad+rnd(sz-pad*2);tr++;}
    while((grid[y][x]!==T.VOID||(y<2&&x<2))&&tr<400);
    enemies.push({y,x,timer:rnd(600),stunTimer:0,
      behavior:ds.enemyBehavior,patrolAngle:Math.random()*Math.PI*2,
      orbitAngle:Math.random()*Math.PI*2,orbitR:2+rnd(3),
      prevY:y,prevX:x,momentum:[0,0],type:'hunter'});
  }

  // Boss for level 6+
  let boss=null;
  if(level>=6&&(ds.id==='summit'||ds.id==='integration')){
    const bx=Math.floor(sz/2),by=Math.floor(sz/2);
    grid[by][bx]=T.VOID;
    boss={y:by,x:bx,hp:5+level,timer:0,stunTimer:0,phase:'chase',phaseTimer:400};
  }

  return {
    grid,enemies,boss,sz,level,ds,
    player:{y:0,x:0},
    hp:prevHp!==undefined?Math.min(UPG.maxHp,prevHp+25):UPG.maxHp,
    score:prevScore||0,
    particles:[],trail:[],echos:[],contZones:[],
    shakeFrames:0,peaceLeft:peaceCount,insightLeft:insCount,
    msg:null,msgColor:'#fff',msgTimer:0,
    flashColor:null,flashAlpha:0,
    tileFlicker:[],resonanceWave:null,peaceStreak:0,
    archetypeActive:false,archetypeType:null,archetypeTimer:0,
    captureZones:[],  // for neighborhood level
    environmentTimer:800+rnd(600),
    environmentActive:false,
    // Spread tracking for despair/hopeless
    spreadTimer:2000,
    // Rewind buffer
    moveHistory:[],
    // Emotional modifiers active
    slowMoves:false,   // hopeless
    speedBoost:false,  // peace matrix bonus
    emotionTimer:0,
  };
}

function initGame(dreamIdx,prevScore,prevLevel,prevHp){
  const level=(prevLevel||0)+1;
  resizeCanvas();
  const ds=DREAMSCAPES[dreamIdx%DREAMSCAPES.length];
  matrixActive=ds.matrixDefault;
  const g=buildDreamscape(ds,SZ(),level,prevScore,prevHp);
  spawnVisions(CW(),CH());
  hallucinations=[];
  glitchTimer=500+rnd(500);
  initStars(CW(),CH());
  return g;
}

function startGame(dreamIdx){
  resetUpgrades();
  insightTokens=0; sessionRep=0; dreamHistory=[];
  game=initGame(dreamIdx||0,0,0,undefined);
  applyPlayMode(game, currentMode); // Apply selected play mode
  phase='playing'; lastMove=0; matrixHoldTime=0;
  cancelAnimationFrame(animId);
  animId=requestAnimationFrame(loop);
}

function nextDreamscape(){
  const g=game;
  const nextIdx=(CFG.dreamIdx+1)%DREAMSCAPES.length;
  CFG.dreamIdx=nextIdx;
  dreamHistory.push(g.ds.id);
  // Store memory echoes
  memoryEchoes=[];
  for(let y=0;y<g.sz;y++) for(let x=0;x<g.sz;x++)
    if(g.grid[y][x]===T.PEACE||g.grid[y][x]===T.INSIGHT) memoryEchoes.push({y,x});

  const ds=DREAMSCAPES[nextIdx];
  interludeState={
    text:g.ds.completionText,
    subtext:ds.narrative,
    timer:220, ds,
  };
  phase='interlude';
  setTimeout(()=>{
    resizeCanvas();
    game=initGame(nextIdx,g.score+400+g.level*60,g.level,g.hp);
    game.msg=`${ds.name}`;
    game.msgColor='#ffdd00'; game.msgTimer=90;
    if(phase==='interlude') phase='playing';
  },3600);
}

function showMsg(text,color,timer){
  if(!game) return;
  game.msg=text; game.msgColor=color; game.msgTimer=timer;
}

function saveScore(score,level,ds){
  highScores.push({score,level,dreamscape:ds?.name||'?',date:new Date().toLocaleDateString()});
  highScores.sort((a,b)=>b.score-a.score);
  highScores=highScores.slice(0,8);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VISION WORDS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function spawnVisions(w,h){
  visions=[];
  for(let i=0;i<5;i++){
    visions.push({text:pick(VISION_WORDS),
      x:40+Math.random()*(w-80),y:90+Math.random()*(h-140),
      alpha:0,targetAlpha:0.04+Math.random()*0.07,
      life:200+rnd(500),maxLife:700,
      dx:(Math.random()-0.5)*0.05,dy:-0.03-Math.random()*0.04,
    });
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PARTICLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function burst(gx,gy,color,count,speed){
  if(!CFG.particles||!game) return;
  for(let i=0;i<count;i++){
    const angle=(Math.PI*2*i/count)+Math.random()*0.6;
    const spd=speed*(0.6+Math.random()*0.8);
    game.particles.push({
      x:gx*(CELL+GAP)+CELL/2, y:gy*(CELL+GAP)+CELL/2,
      vx:Math.cos(angle)*spd, vy:Math.sin(angle)*spd-1,
      r:2+Math.random()*3, color,
      life:20+rnd(16),maxLife:36,
    });
  }
}

function resonanceWave(cx,cy,color){
  if(!CFG.particles||!game) return;
  game.resonanceWave={x:cx*(CELL+GAP)+CELL/2,y:cy*(CELL+GAP)+CELL/2,
    r:0,maxR:GP()*0.65,color,alpha:0.55};
}

function addEcho(g){
  if(!CFG.particles) return;
  g.echos.push({
    x:g.player.x*(CELL+GAP)+CELL/2, y:g.player.y*(CELL+GAP)+CELL/2,
    life:30,maxLife:30,size:CELL*0.38,
    color:matrixActive==='A'?'rgba(200,0,80,0.35)':'rgba(0,255,136,0.3)',
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ARCHETYPE ACTIVATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function activateArchetype(g,type){
  const arch=ARCHETYPES[type];
  if(!arch) return;
  g.archetypeActive=true;
  g.archetypeType=type;
  g.archetypeTimer=180; // frames
  UPG.archetypePower=arch.power;
  UPG.archetypeDuration=180;
  showMsg(arch.activationMsg,'#ffdd00',70);
  resonanceWave(g.player.x,g.player.y,'#ffdd00');
  burst(g.player.x,g.player.y,'#ffdd00',24,4);

  // Immediate power effects
  if(type==='child'){
    // Reveal hidden tiles
    const sz=g.sz;
    for(let y=0;y<sz;y++) for(let x=0;x<sz;x++)
      if(g.grid[y][x]===T.HIDDEN) g.tileFlicker.push({y,x,t:200,reveal:true});
    showMsg('CHILD REVEALS THE PATHâ€¦','#aaffcc',60);
  }
  if(type==='protector'){
    UPG.shield=true; UPG.shieldTimer=30;
    burst(g.player.x,g.player.y,'#88ccff',20,5);
  }
  if(type==='orb'){
    UPG.phaseShift=true; UPG.phaseTimer=15; // 15 moves through walls
  }
  if(type==='captor'){
    // Rewind is now available for 3 uses
    UPG.temporalRewind=true;
    UPG.rewindBuffer=UPG.rewindBuffer.slice(-3);
  }
}

function executeArchetypePower(g){
  if(!UPG.archetypePower) return;
  const power=UPG.archetypePower;
  if(power==='wall_jump'){
    // Dragon: jump 2 tiles in last direction or random open
    const dirs=[[-2,0],[2,0],[0,-2],[0,2]];
    for(const [dy,dx] of dirs){
      const ny=g.player.y+dy,nx=g.player.x+dx;
      if(ny>=0&&ny<g.sz&&nx>=0&&nx<g.sz&&g.grid[ny][nx]!==T.WALL){
        addEcho(g); g.player.y=ny; g.player.x=nx;
        burst(nx,ny,'#ffaa00',16,3);
        showMsg('DRAGON LEAP!','#ffaa00',35);
        break;
      }
    }
  }
  else if(power==='phase_walk'){
    UPG.phaseShift=true; UPG.phaseTimer=10;
    showMsg('ORB PHASE ACTIVE','#aaddff',35);
  }
  else if(power==='rewind'){
    if(UPG.rewindBuffer.length>0){
      const snap=UPG.rewindBuffer.pop();
      g.player.y=snap.y; g.player.x=snap.x;
      // restore grid state
      if(snap.grid) for(let y=0;y<g.sz;y++) for(let x=0;x<g.sz;x++) g.grid[y][x]=snap.grid[y][x];
      burst(g.player.x,g.player.y,'#ffaadd',20,3);
      showMsg('TEMPORAL REWIND','#ffaadd',40);
    } else showMsg('NO REWIND MEMORY','#443344',30);
  }
  else if(power==='shield_burst'){
    UPG.shield=true; UPG.shieldTimer=25;
    // Stun all enemies
    for(const e of g.enemies) e.stunTimer=1500;
    if(g.boss) g.boss.stunTimer=2000;
    burst(g.player.x,g.player.y,'#88ccff',30,6);
    showMsg('PROTECT â€” ENEMIES STUNNED!','#88ccff',55);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ENVIRONMENTAL EVENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function triggerEnvironmentEvent(g){
  const event=g.ds.environmentEvent;
  const sz=g.sz;
  if(!event) return;

  if(event==='gravity_shift'){
    // Randomly push player 1 tile
    const dirs=[[-1,0],[1,0],[0,-1],[0,1]];
    const [dy,dx]=pick(dirs);
    const ny=g.player.y+dy,nx=g.player.x+dx;
    if(ny>=0&&ny<sz&&nx>=0&&nx<sz&&g.grid[ny][nx]!==T.WALL){
      g.player.y=ny; g.player.x=nx;
      showMsg('GRAVITY SHIFTSâ€¦','#8888ff',40);
    }
  }
  else if(event==='loop_reset'){
    // Some tiles near player reset to frustration tiles
    for(let dy=-2;dy<=2;dy++) for(let dx=-2;dx<=2;dx++){
      const ny=g.player.y+dy,nx=g.player.x+dx;
      if(ny>=0&&ny<sz&&nx>=0&&nx<sz&&g.grid[ny][nx]===T.VOID&&Math.random()<0.25)
        g.grid[ny][nx]=T.RAGE;
    }
    showMsg('THE LOOP TIGHTENSâ€¦','#ff8800',40);
  }
  else if(event==='capture_zones'){
    // Mark a zone around a random enemy as capture zone
    const e=pick(g.enemies);
    if(e) g.captureZones=[{x:e.x,y:e.y,r:2,timer:300}];
    showMsg('CAPTURE ZONE ACTIVATED','#ff2244',40);
  }
  else if(event==='rapid_spawn'){
    // Add 1 extra enemy briefly
    if(g.enemies.length<10){
      const y=2+rnd(sz-4),x=2+rnd(sz-4);
      g.enemies.push({y,x,timer:0,stunTimer:0,behavior:'rush',
        patrolAngle:0,orbitAngle:0,orbitR:2,prevY:y,prevX:x,momentum:[0,0],type:'rush'});
      showMsg('CHAOS ERUPTS!','#ff0044',40);
    }
  }
  else if(event==='wall_phase'){
    // Orb event: temporarily make 4 walls passable (set as glitch)
    let n=0;
    for(let y=0;y<sz&&n<4;y++) for(let x=0;x<sz&&n<4;x++){
      if(g.grid[y][x]===T.WALL&&Math.random()<0.3){g.grid[y][x]=T.GLITCH;n++;}
    }
    showMsg('MEMBRANE DISSOLVESâ€¦','#00ccff',40);
  }
  else if(event==='glide_nodes'){
    spawnTile(g.grid,2,T.TELEPORT,sz,true);
    showMsg('GLIDE NODES APPEAR','#00aaff',40);
  }
  else if(event==='mashup'){
    // Add tiles from a random other dreamscape
    const otherDs=pick(DREAMSCAPES.filter(d=>d.id!==g.ds.id));
    if(otherDs.hazardSet[0]) spawnTile(g.grid,3,otherDs.hazardSet[0],sz,true);
    showMsg('DREAMSCAPES MERGEâ€¦','#ffaaff',40);
  }

  // Universal: anomaly pulse
  if(Math.random()<0.4){
    const row=rnd(sz);
    for(let x=0;x<sz;x++){
      if(g.grid[row][x]===T.DESPAIR) g.grid[row][x]=T.PEACE;
      else if(g.grid[row][x]===T.PEACE&&Math.random()<0.3) g.grid[row][x]=T.DESPAIR;
    }
    anomalyData={row,col:-1,t:50};
    anomalyActive=true;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ENEMY AI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function stepEnemies(dt){
  const g=game; const sz=g.sz; const d=DIFF();
  if(!g||g.hp<=0) return;

  if(UPG.freeze&&UPG.freezeTimer>0){UPG.freezeTimer-=dt;return;}

  // Emotional slow-down: hopeless
  const slowMul=g.slowMoves?1.5:1.0;
  const baseSpeed=d.eSpeedBase-g.level*30;
  const mSpeed=Math.max(d.eSpeedMin,baseSpeed)*(matrixActive==='A'?0.65:1.0)*slowMul;

  // Hallucinations (level 3+, chaos phantom)
  if(g.level>=3){
    hallucinations=hallucinations.filter(h=>h.life>0);
    if(Math.random()<0.0006*g.level&&hallucinations.length<3){
      const y=rnd(sz),x=rnd(sz);
      if(g.grid[y][x]===T.VOID) hallucinations.push({y,x,timer:0,life:5000+rnd(4000),ds:g.ds.id});
    }
    for(const h of hallucinations){
      h.life-=dt; h.timer+=dt;
      if(h.timer>450){
        h.timer=0;
        const tdx=g.player.x-h.x,tdy=g.player.y-h.y;
        const dy=tdy>0?1:tdy<0?-1:0, dx=tdx>0?1:tdx<0?-1:0;
        const ny=h.y+dy,nx=h.x+dx;
        if(ny>=0&&ny<sz&&nx>=0&&nx<sz) {h.y=ny;h.x=nx;}
        if(h.y===g.player.y&&h.x===g.player.x){
          g.hp=Math.max(0,g.hp-8); h.life=0;
          g.shakeFrames=4; g.flashColor='#8800ff'; g.flashAlpha=0.18;
          showMsg('CHAOS PHANTOM!','#aa00ff',35);
        }
      }
    }
  }

  // Boss
  if(g.boss&&g.boss.hp>0){
    const b=g.boss; b.timer+=dt; b.phaseTimer-=dt;
    if(b.phaseTimer<=0){b.phase=b.phase==='chase'?'orbit':'chase';b.phaseTimer=400+rnd(300);}
    if(b.timer>280){
      b.timer=0;
      const tdx=g.player.x-b.x,tdy=g.player.y-b.y;
      // Predictive at high levels
      let tx=g.player.x,ty=g.player.y;
      if(g.level>=8){
        tx+=keys.has('ArrowRight')||keys.has('d')?1:keys.has('ArrowLeft')||keys.has('a')?-1:0;
        ty+=keys.has('ArrowDown')||keys.has('s')?1:keys.has('ArrowUp')||keys.has('w')?-1:0;
      }
      const bdy=ty-b.y,bdx=tx-b.x;
      const dy=bdy>0?1:bdy<0?-1:0,dx=bdx>0?1:bdx<0?-1:0;
      if(dy&&b.y+dy>=0&&b.y+dy<sz) b.y+=dy;
      else if(dx&&b.x+dx>=0&&b.x+dx<sz) b.x+=dx;
      if(b.y===g.player.y&&b.x===g.player.x){
        const dmg=Math.round(40*d.dmgMul*(matrixActive==='A'?1.3:1));
        g.hp=Math.max(0,g.hp-dmg);
        g.shakeFrames=14; g.flashColor='#ff00aa'; g.flashAlpha=0.45;
        burst(g.player.x,g.player.y,'#ff00aa',22,5);
        showMsg('BOSS! -'+dmg,'#ff00aa',50);
      }
    }
  }

  // Regular enemies
  for(const e of g.enemies){
    if(e.stunTimer>0){e.stunTimer-=dt;continue;}
    e.timer+=dt;
    if(e.timer<mSpeed) continue;
    e.timer=0;
    e.prevY=e.y; e.prevX=e.x;

    const beh=e.behavior||g.ds.enemyBehavior;
    const tdx=g.player.x-e.x,tdy=g.player.y-e.y;
    const dist=Math.abs(tdx)+Math.abs(tdy);
    let moved=false;

    if(beh==='wander'||dist>sz*0.7){
      // Random walk
      const dirs=[[1,0],[-1,0],[0,1],[0,-1]].sort(()=>Math.random()-0.5);
      for(const [dy,dx] of dirs){
        const ny=e.y+dy,nx=e.x+dx;
        if(ny>=0&&ny<sz&&nx>=0&&nx<sz&&g.grid[ny][nx]!==T.WALL){e.y=ny;e.x=nx;moved=true;break;}
      }
    }
    else if(beh==='patrol'){
      // Patrol in angle then chase when close
      e.patrolAngle+=(Math.random()-0.5)*0.4;
      const dy=Math.round(Math.sin(e.patrolAngle)),dx=Math.round(Math.cos(e.patrolAngle));
      const ny=e.y+clamp(dy,-1,1),nx=e.x+clamp(dx,-1,1);
      if(ny>=0&&ny<sz&&nx>=0&&nx<sz&&g.grid[ny][nx]!==T.WALL){e.y=ny;e.x=nx;moved=true;}
      if(dist<5&&Math.random()<0.7){
        const pdy=tdy>0?1:tdy<0?-1:0,pdx=tdx>0?1:tdx<0?-1:0;
        const ny2=e.y+pdy,nx2=e.x+pdx;
        if(ny2>=0&&ny2<sz&&nx2>=0&&nx2<sz&&g.grid[ny2][nx2]!==T.WALL){e.y=ny2;e.x=nx2;}
      }
    }
    else if(beh==='orbit'){
      // Orbit player at set radius
      e.orbitAngle+=0.25;
      const tx=g.player.x+Math.round(Math.cos(e.orbitAngle)*e.orbitR);
      const ty=g.player.y+Math.round(Math.sin(e.orbitAngle)*e.orbitR);
      const dy=ty-e.y>0?1:ty-e.y<0?-1:0;
      const dx=tx-e.x>0?1:tx-e.x<0?-1:0;
      if(e.y+dy>=0&&e.y+dy<sz&&e.x+dx>=0&&e.x+dx<sz&&g.grid[e.y+dy][e.x+dx]!==T.WALL){e.y+=dy;e.x+=dx;}
    }
    else if(beh==='chase_fast'||beh==='adaptive'||beh==='predictive'){
      const pref=[];
      let tx=g.player.x,ty=g.player.y;
      if(beh==='predictive'&&g.level>=7){
        tx+=keys.has('ArrowRight')||keys.has('d')?1:keys.has('ArrowLeft')||keys.has('a')?-1:0;
        ty+=keys.has('ArrowDown')||keys.has('s')?1:keys.has('ArrowUp')||keys.has('w')?-1:0;
      }
      const cx=tx-e.x,cy=ty-e.y;
      if(Math.abs(cy)>=Math.abs(cx)) pref.push([cy>0?1:-1,0],[0,cx>0?1:-1]);
      else pref.push([0,cx>0?1:-1],[cy>0?1:-1,0]);
      for(const [dy,dx] of pref){
        const ny=e.y+dy,nx=e.x+dx;
        if(ny>=0&&ny<sz&&nx>=0&&nx<sz&&g.grid[ny][nx]!==T.WALL){e.y=ny;e.x=nx;moved=true;break;}
      }
      if(!moved){
        const dirs=[[1,0],[-1,0],[0,1],[0,-1]].sort(()=>Math.random()-0.5);
        for(const [dy,dx] of dirs){const ny=e.y+dy,nx=e.x+dx;
          if(ny>=0&&ny<sz&&nx>=0&&nx<sz&&g.grid[ny][nx]!==T.WALL){e.y=ny;e.x=nx;break;}}
      }
    }
    else if(beh==='rush'){
      // Always chase, ignore distance threshold
      const pref=[];
      if(Math.abs(tdy)>=Math.abs(tdx)) pref.push([tdy>0?1:-1,0],[0,tdx>0?1:-1]);
      else pref.push([0,tdx>0?1:-1],[tdy>0?1:-1,0]);
      for(const [dy,dx] of pref){const ny=e.y+dy,nx=e.x+dx;
        if(ny>=0&&ny<sz&&nx>=0&&nx<sz&&g.grid[ny][nx]!==T.WALL){e.y=ny;e.x=nx;moved=true;break;}}
      if(!moved){const dirs=[[1,0],[-1,0],[0,1],[0,-1]].sort(()=>Math.random()-0.5);
        for(const [dy,dx] of dirs){const ny=e.y+dy,nx=e.x+dx;
          if(ny>=0&&ny<sz&&nx>=0&&nx<sz&&g.grid[ny][nx]!==T.WALL){e.y=ny;e.x=nx;break;}}}
    }
    else if(beh==='scatter'){
      // Move AWAY from player
      const pref=[];
      if(Math.abs(tdy)>=Math.abs(tdx)) pref.push([tdy>0?-1:1,0],[0,tdx>0?-1:1]);
      else pref.push([0,tdx>0?-1:1],[tdy>0?-1:1,0]);
      for(const [dy,dx] of pref){const ny=e.y+dy,nx=e.x+dx;
        if(ny>=0&&ny<sz&&nx>=0&&nx<sz&&g.grid[ny][nx]!==T.WALL){e.y=ny;e.x=nx;moved=true;break;}}
      if(!moved){const dirs=[[1,0],[-1,0],[0,1],[0,-1]].sort(()=>Math.random()-0.5);
        for(const [dy,dx] of dirs){const ny=e.y+dy,nx=e.x+dx;
          if(ny>=0&&ny<sz&&nx>=0&&nx<sz&&g.grid[ny][nx]!==T.WALL){e.y=ny;e.x=nx;break;}}}
    }
    else { // labyrinth / default
      const dirs=[[1,0],[-1,0],[0,1],[0,-1]].sort(()=>Math.random()-0.5);
      for(const [dy,dx] of dirs){const ny=e.y+dy,nx=e.x+dx;
        if(ny>=0&&ny<sz&&nx>=0&&nx<sz&&g.grid[ny][nx]!==T.WALL){e.y=ny;e.x=nx;break;}}
    }

    // Hit player
    if(e.y===g.player.y&&e.x===g.player.x){
      if(UPG.shield&&UPG.shieldTimer>0){
        e.stunTimer=1300;
        showMsg('SHIELD HELD!','#00ffcc',38);
        burst(g.player.x,g.player.y,'#00ffcc',14,3);
      } else {
        const dmg=Math.round(22*d.dmgMul*(matrixActive==='A'?1.3:1));
        g.hp=Math.max(0,g.hp-dmg);
        g.shakeFrames=8; g.flashColor='#ff2200'; g.flashAlpha=0.35;
        burst(g.player.x,g.player.y,'#ff4400',16,4);
        e.stunTimer=900; UPG.shieldCount=0; UPG.comboCount=0;
        showMsg('HIT! -'+dmg,'#ff4400',40);
        setEmotion(g,'panic');
      }
    }
    // Capture zone check
    for(const cz of g.captureZones){
      if(Math.abs(e.x-g.player.x)<=cz.r&&Math.abs(e.y-g.player.y)<=cz.r){
        g.hp=Math.max(0,g.hp-5); showMsg('CAPTURED!','#ff0044',25);
      }
    }
  }
  g.captureZones=g.captureZones.filter(c=>{c.timer--;return c.timer>0;});
}

function setEmotion(g,em){
  UPG.emotion=em; UPG.emotionTimer=120;
  g.emotionTimer=120; g.slowMoves=(em==='hopeless'||em==='despair');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PLAYER MOVEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function tryMove(dy,dx){
  const g=game; const sz=g.sz;
  const ny=g.player.y+dy, nx=g.player.x+dx;
  if(ny<0||ny>=sz||nx<0||nx>=sz) return false;

  const tileType=g.grid[ny][nx];

  // Wall / hidden logic
  if(tileType===T.WALL){
    if(UPG.phaseShift&&UPG.phaseTimer>0){
      // Orb phase: pass through
    } else return false;
  }
  if(tileType===T.HIDDEN&&matrixActive==='A'&&!UPG.phaseShift) return false;

  // Save rewind buffer
  if(UPG.temporalRewind&&UPG.rewindBuffer.length<8){
    const gridSnap=g.grid.map(row=>[...row]);
    UPG.rewindBuffer.push({y:g.player.y,x:g.player.x,grid:gridSnap});
  }
  // Also save in game move history
  g.moveHistory.push({y:g.player.y,x:g.player.x});
  if(g.moveHistory.length>15) g.moveHistory.shift();

  addEcho(g);
  if(CFG.particles) g.trail.push({
    x:g.player.x*(CELL+GAP)+CELL/2, y:g.player.y*(CELL+GAP)+CELL/2,
    life:14,maxLife:14,
    color:matrixActive==='A'?'rgba(180,0,80,0.45)':'rgba(0,255,136,0.38)',
  });

  g.player.y=ny; g.player.x=nx;

  // Phase timer
  if(UPG.phaseShift&&UPG.phaseTimer>0){UPG.phaseTimer--;if(UPG.phaseTimer<=0){UPG.phaseShift=false;showMsg('PHASE FADED','#445566',25);}}
  // Shield timer
  if(UPG.shield&&UPG.shieldTimer>0){UPG.shieldTimer--;if(UPG.shieldTimer<=0){UPG.shield=false;showMsg('SHIELD FADED','#445566',25);}}
  // Energy
  if(matrixActive==='A') UPG.energy=Math.max(0,UPG.energy-0.9);
  else UPG.energy=Math.min(UPG.energyMax,UPG.energy+0.5);
  // Archetype duration
  if(g.archetypeActive){g.archetypeTimer--;if(g.archetypeTimer<=0){g.archetypeActive=false;UPG.archetypePower=null;}}

  // â”€â”€ Tile effects â”€â”€
  if(tileType===T.PEACE){
    const pts=Math.round((150+g.level*20)*UPG.resonanceMultiplier);
    g.score+=pts; sessionRep+=2;
    g.hp=Math.min(UPG.maxHp,g.hp+20);
    g.grid[ny][nx]=T.VOID; g.peaceLeft--;
    burst(nx,ny,UPG.particleColor,18,3.5);
    UPG.shieldCount++; UPG.comboCount++;
    UPG.resonanceMultiplier=Math.min(4,1+UPG.comboCount*0.25);
    UPG.glitchPulseCharge=Math.min(100,UPG.glitchPulseCharge+15);
    if(UPG.comboCount>=3&&!UPG.shield){
      UPG.shield=true; UPG.shieldTimer=20;
      resonanceWave(nx,ny,'#00ffcc');
      burst(nx,ny,'#00ffcc',26,5);
      showMsg('SHIELD ACTIVE! Ã—'+UPG.resonanceMultiplier.toFixed(1),'#00ffcc',55);
    } else showMsg('+PEACE +'+pts+(UPG.comboCount>1?' Ã—'+UPG.resonanceMultiplier.toFixed(1):''),'#00ffcc',38);
    setEmotion(g,'peace');
    if(g.peaceLeft===0) nextDreamscape();

  } else if(tileType===T.INSIGHT){
    const pts=Math.round((300+g.level*50)*UPG.resonanceMultiplier);
    g.score+=pts; insightTokens+=1; sessionRep+=5;
    g.grid[ny][nx]=T.VOID; g.insightLeft--;
    burst(nx,ny,'#00eeff',24,4);
    resonanceWave(nx,ny,'#00eeff');
    showMsg('INSIGHT â—†Ã—'+insightTokens,'#00eeff',60);
    // Reveal hidden tiles
    for(let y=0;y<sz;y++) for(let x=0;x<sz;x++)
      if(g.grid[y][x]===T.HIDDEN) g.tileFlicker.push({y,x,t:100,reveal:true});
    setEmotion(g,'clarity');

  } else if(tileType===T.ARCHETYPE){
    g.grid[ny][nx]=T.VOID;
    const arch=g.ds.archetype||'orb';
    activateArchetype(g,arch);

  } else if(tileType===T.TELEPORT){
    // Leaping field: teleport to random open tile
    let tries=0,ty=rnd(sz),tx=rnd(sz);
    while((g.grid[ty][tx]!==T.VOID||(ty===ny&&tx===nx))&&tries<200){ty=rnd(sz);tx=rnd(sz);tries++;}
    g.player.y=ty; g.player.x=tx;
    g.grid[ny][nx]=T.VOID;
    burst(tx,ty,'#00aaff',16,3);
    showMsg('LEAP!','#00aaff',30);

  } else if(tileType===T.COVER){
    // Cover tile: player is hidden from enemies for a few turns
    showMsg('COVER','#446688',20);
    // Stun nearby enemies briefly
    for(const e of g.enemies){
      if(Math.abs(e.y-ny)+Math.abs(e.x-nx)<=2) e.stunTimer=600;
    }
  } else if(tileType===T.MEMORY){
    g.grid[ny][nx]=T.VOID;
    g.score+=50;
    showMsg('MEMORY ECHOâ€¦','#88bbaa',30);
    burst(nx,ny,'#88bbaa',10,2);

  } else if(TILE_DEF[tileType]&&TILE_DEF[tileType].dmg>0){
    if(UPG.shield&&UPG.shieldTimer>0){
      showMsg('SHIELDED','#00ffcc',20);
    } else {
      const d=DIFF();
      const def=TILE_DEF[tileType];
      let dmg=Math.round(def.dmg*d.dmgMul*(matrixActive==='A'?1.25:1));

      // RAGE: push back
      if(tileType===T.RAGE&&def.push>0){
        const pby=ny+dy*def.push, pbx=nx+dx*def.push;
        if(pby>=0&&pby<sz&&pbx>=0&&pbx<sz&&g.grid[pby][pbx]!==T.WALL){
          g.player.y=pby; g.player.x=pbx;
          showMsg('-RAGE (pushed!)','#ff0066',40);
        }
      }
      // SELF_HARM: leave pain tile
      if(tileType===T.SELF_HARM) g.grid[ny][nx]=T.PAIN;
      // HOPELESS: emotional slow
      if(tileType===T.HOPELESS) setEmotion(g,'hopeless');
      // DESPAIR: spread
      if(tileType===T.DESPAIR&&Math.random()<0.3){
        const spreadDirs=[[1,0],[-1,0],[0,1],[0,-1]];
        const [sdy,sdx]=pick(spreadDirs);
        const sy=ny+sdy,sx=nx+sdx;
        if(sy>=0&&sy<sz&&sx>=0&&sx<sz&&g.grid[sy][sx]===T.VOID) g.grid[sy][sx]=T.DESPAIR;
      }

      g.hp=Math.max(0,g.hp-dmg);
      g.shakeFrames=5;
      const dmgColors={[T.DESPAIR]:'#2244ff',[T.TERROR]:'#ff0000',[T.SELF_HARM]:'#660000',
        [T.RAGE]:'#ff0044',[T.HOPELESS]:'#004488',[T.GLITCH]:'#aa00ff',
        [T.TRAP]:'#ff8800',[T.PAIN]:'#440000'};
      g.flashColor=dmgColors[tileType]||'#ff0000'; g.flashAlpha=0.28;
      const pColors={[T.DESPAIR]:'#3355ff',[T.TERROR]:'#ff2222',[T.SELF_HARM]:'#880000',
        [T.RAGE]:'#ff0044',[T.HOPELESS]:'#004488',[T.GLITCH]:'#aa00ff',
        [T.TRAP]:'#ff8800',[T.PAIN]:'#440000'};
      burst(nx,ny,pColors[tileType]||'#ff2222',10,3);
      const msgs={[T.DESPAIR]:'-DESPAIR',[T.TERROR]:'-TERROR!',[T.SELF_HARM]:'-SELFÂ·HARM',
        [T.RAGE]:'-RAGE',[T.HOPELESS]:'-HOPELESS',[T.GLITCH]:'-GLITCH',
        [T.TRAP]:'-TRAP',[T.PAIN]:'-PAIN'};
      showMsg((msgs[tileType]||'-HAZARD')+' -'+dmg,(pColors[tileType]||'#ff3333'),38);
      sessionRep-=1; UPG.shieldCount=0; UPG.comboCount=0; UPG.resonanceMultiplier=1;
    }
  }
  return true;
}

// Magnet: attract nearest peace/insight
function tryMagnet(){
  if(!UPG.magnet||!game) return;
  const g=game,sz=g.sz;
  let best=9999,bdy=0,bdx=0,found=false;
  for(let y=0;y<sz;y++) for(let x=0;x<sz;x++){
    const v=g.grid[y][x];
    if(v===T.PEACE||v===T.INSIGHT){
      const d=Math.abs(y-g.player.y)+Math.abs(x-g.player.x);
      if(d<=2&&d<best){best=d;bdy=y-g.player.y;bdx=x-g.player.x;found=true;}
    }
  }
  if(found){
    const dy=bdy>0?1:bdy<0?-1:0, dx=bdx>0?1:bdx<0?-1:0;
    tryMove(dy,0)||tryMove(0,dx);
  }
}

// Glitch pulse: clear hazards in radius
function triggerGlitchPulse(){
  const g=game; if(!g||UPG.glitchPulseCharge<100) return;
  UPG.glitchPulseCharge=0;
  const sz=g.sz;
  let cleared=0;
  for(let y=0;y<sz;y++) for(let x=0;x<sz;x++){
    const d=Math.abs(y-g.player.y)+Math.abs(x-g.player.x);
    if(d<=3&&TILE_DEF[g.grid[y][x]]&&TILE_DEF[g.grid[y][x]].dmg>0){
      g.grid[y][x]=T.VOID; cleared++;
    }
  }
  for(const e of g.enemies) if(Math.abs(e.y-g.player.y)+Math.abs(e.x-g.player.x)<=4) e.stunTimer=1800;
  resonanceWave(g.player.x,g.player.y,'#aa00ff');
  burst(g.player.x,g.player.y,'#aa00ff',32,6);
  showMsg('GLITCH PULSE! '+cleared+' CLEARED','#aa00ff',55);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TILE SPREAD (despair/hopeless) â€” called each frame
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function stepTileSpread(dt){
  const g=game; if(!g) return;
  g.spreadTimer-=dt;
  if(g.spreadTimer>0) return;
  g.spreadTimer=3000+rnd(1000);
  const sz=g.sz;
  const candidates=[];
  for(let y=0;y<sz;y++) for(let x=0;x<sz;x++){
    const v=g.grid[y][x];
    if((v===T.DESPAIR||v===T.HOPELESS)&&TILE_DEF[v].spread){
      const dirs=[[1,0],[-1,0],[0,1],[0,-1]];
      for(const [dy,dx] of dirs){
        const ny=y+dy,nx=x+dx;
        if(ny>=0&&ny<sz&&nx>=0&&nx<sz&&g.grid[ny][nx]===T.VOID&&Math.random()<0.2)
          candidates.push({y:ny,x:nx,type:v});
      }
    }
  }
  // Apply spread (max 2 new tiles)
  const spread=candidates.slice(0,2);
  for(const c of spread) g.grid[c.y][c.x]=c.type;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DRAW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function draw(ts){
  const g=game; if(!g) return;
  const sz=g.sz,gp=GP(),w=CW(),h=CH();
  const P=PAL();
  const ds=g.ds;

  ctx.clearRect(0,0,w,h);

  // â”€â”€ Dreamscape background â”€â”€
  ctx.fillStyle=ds.bgColor; ctx.fillRect(0,0,w,h);
  // Accent gradient
  const bg2=ctx.createRadialGradient(w*0.7,h*0.3,0,w*0.7,h*0.3,w*0.8);
  bg2.addColorStop(0,ds.bgAccent+'33');bg2.addColorStop(1,'transparent');
  ctx.fillStyle=bg2;ctx.fillRect(0,0,w,h);

  // Matrix A tint
  if(matrixActive==='A'){ctx.fillStyle='rgba(80,0,20,0.07)';ctx.fillRect(0,0,w,h);}

  // Scanlines
  for(let y=0;y<h;y+=3){ctx.fillStyle='rgba(0,0,0,0.06)';ctx.fillRect(0,y,w,1);}

  // Background stars (celestial motif)
  for(const s of backgroundStars){
    const a=s.a*(0.5+0.5*Math.sin(ts*0.0008+s.phase));
    ctx.globalAlpha=a;ctx.fillStyle='#ffffff';
    ctx.beginPath();ctx.arc(s.x,s.y,s.r,0,Math.PI*2);ctx.fill();
  }
  ctx.globalAlpha=1;

  // Glitch effect
  if(glitchFrames>0){
    ctx.fillStyle=`rgba(${matrixActive==='A'?'180,0,60':'0,180,60'},0.04)`;
    ctx.fillRect(0,rnd(h),w,2+rnd(4));
    try{
      const img=ctx.getImageData(0,rnd(h)*DPR,w*DPR,2);
      ctx.putImageData(img,rnd(8)-4,rnd(h));
    }catch(e){}
    glitchFrames--;
  }

  // Shake
  let ox=0,oy=0;
  if(g.shakeFrames>0){
    ox=(Math.random()-0.5)*9*(g.shakeFrames/10);
    oy=(Math.random()-0.5)*9*(g.shakeFrames/10);
    g.shakeFrames--;
  }
  const sx=(w-gp)/2+ox, sy=100+oy;

  // â”€â”€ Vision words â”€â”€
  for(const v of visions){
    v.x+=v.dx;v.y+=v.dy;v.life--;
    if(v.life>v.maxLife*0.85) v.alpha=Math.min(v.targetAlpha,(v.maxLife-v.life)/(v.maxLife*0.15)*v.targetAlpha);
    else if(v.life<v.maxLife*0.15) v.alpha=Math.max(0,(v.life/(v.maxLife*0.15))*v.targetAlpha);
    if(v.life<=0){v.text=pick(VISION_WORDS);v.x=40+Math.random()*(w-80);
      v.y=100+Math.random()*(h-150);v.life=200+rnd(400);v.maxLife=600;}
    ctx.globalAlpha=v.alpha*(matrixActive==='A'?0.7:1);
    ctx.fillStyle=matrixActive==='A'?'#ff4488':'#00aa55';
    ctx.font='9px Courier New';ctx.textAlign='center';
    ctx.fillText(v.text,v.x,v.y);
  }
  ctx.globalAlpha=1;ctx.textAlign='left';

  // â”€â”€ Grid â”€â”€
  for(let y=0;y<sz;y++){
    for(let x=0;x<sz;x++){
      const raw=g.grid[y][x];
      const fl=g.tileFlicker.find(f=>f.y===y&&f.x===x);
      const val=(fl&&fl.reveal&&raw===T.HIDDEN)?T.INSIGHT:raw;
      const td=TILE_DEF[val]||TILE_DEF[T.VOID];
      const tp=P[val]||P[T.VOID];
      const px=sx+x*(CELL+GAP), py=sy+y*(CELL+GAP);

      // Anomaly highlight
      if(anomalyActive&&(y===anomalyData.row||x===anomalyData.col)){ctx.shadowColor='#ffaa00';ctx.shadowBlur=10;}
      else if(tp.glow){ctx.shadowColor=tp.glow;ctx.shadowBlur=12;}
      else ctx.shadowBlur=0;

      ctx.fillStyle=tp.bg;
      ctx.beginPath();ctx.roundRect(px,py,CELL,CELL,4);ctx.fill();
      ctx.strokeStyle=tp.bd;ctx.lineWidth=1;
      ctx.beginPath();ctx.roundRect(px+0.5,py+0.5,CELL-1,CELL-1,4);ctx.stroke();
      ctx.shadowBlur=0;

      // Peace shimmer
      if(val===T.PEACE){
        const s2=(ts*0.05+y*6+x*4)%(CELL*2);
        if(s2<CELL){const gr=ctx.createLinearGradient(px,py+s2-5,px,py+s2+5);
          gr.addColorStop(0,'rgba(0,255,140,0)');gr.addColorStop(0.5,'rgba(0,255,140,0.45)');
          gr.addColorStop(1,'rgba(0,255,140,0)');ctx.fillStyle=gr;ctx.fillRect(px,py,CELL,CELL);}
        ctx.shadowColor='#00ffaa';ctx.shadowBlur=10;ctx.fillStyle='#00ffaa';
        ctx.beginPath();ctx.arc(px+CELL/2,py+CELL/2,5+2*Math.sin(ts*0.006+x+y),0,Math.PI*2);ctx.fill();
        ctx.shadowBlur=0;
      }
      // Insight sparkle
      if(val===T.INSIGHT){
        ctx.shadowColor='#00eeff';ctx.shadowBlur=14;
        const angle=ts*0.008+x*1.7+y*1.3;
        for(let i=0;i<4;i++){
          const a=angle+i*Math.PI*0.5, r=7+2*Math.sin(ts*0.005+i);
          ctx.fillStyle=i%2===0?'#00eeff':'#00aacc';
          ctx.beginPath();ctx.arc(px+CELL/2+Math.cos(a)*r,py+CELL/2+Math.sin(a)*r,2.5,0,Math.PI*2);ctx.fill();
        }
        ctx.shadowBlur=0;
      }
      // Archetype tile glow
      if(val===T.ARCHETYPE){
        const pulse=0.5+0.5*Math.sin(ts*0.01+x+y);
        ctx.shadowColor='#ffdd00';ctx.shadowBlur=16*pulse;
        ctx.fillStyle=`rgba(255,220,0,${0.15*pulse})`;ctx.fillRect(px,py,CELL,CELL);
        ctx.font='18px Courier New';ctx.textAlign='center';
        ctx.fillStyle='#ffee44';ctx.fillText('â˜†',px+CELL/2,py+CELL/2+6);
        ctx.shadowBlur=0;ctx.textAlign='left';
      }
      // Teleport pulse
      if(val===T.TELEPORT){
        const pulse=0.5+0.5*Math.sin(ts*0.012+x*2+y);
        ctx.shadowColor='#00aaff';ctx.shadowBlur=12*pulse;
        ctx.fillStyle=`rgba(0,170,255,${0.2*pulse})`;ctx.fillRect(px,py,CELL,CELL);
        ctx.font='14px Courier New';ctx.textAlign='center';
        ctx.fillStyle='#00ccff';ctx.fillText('â‡’',px+CELL/2,py+CELL/2+5);
        ctx.shadowBlur=0;ctx.textAlign='left';
      }
      // Memory echo tile
      if(val===T.MEMORY){
        const pulse=0.3+0.3*Math.sin(ts*0.004+x+y);
        ctx.globalAlpha=0.4+0.2*pulse;
        ctx.fillStyle='rgba(100,200,150,0.15)';ctx.fillRect(px,py,CELL,CELL);
        ctx.globalAlpha=1;
      }
      // Tile symbol
      if(td.sym&&val!==T.VOID&&val!==T.WALL&&val!==T.PEACE&&val!==T.INSIGHT&&
         val!==T.ARCHETYPE&&val!==T.TELEPORT&&val!==T.HIDDEN&&val!==T.MEMORY){
        ctx.fillStyle=tp.bd;ctx.font='12px Courier New';ctx.textAlign='center';
        ctx.globalAlpha=0.55;ctx.fillText(td.sym,px+CELL/2,py+CELL/2+5);
        ctx.globalAlpha=1;ctx.textAlign='left';
      }
      // Magnet range ring
      if((val===T.PEACE||val===T.INSIGHT)&&UPG.magnet){
        const md=Math.abs(y-g.player.y)+Math.abs(x-g.player.x);
        if(md<=2){ctx.strokeStyle='rgba(0,255,180,0.28)';ctx.lineWidth=1;
          ctx.beginPath();ctx.roundRect(px+2,py+2,CELL-4,CELL-4,4);ctx.stroke();}
      }
    }
  }
  g.tileFlicker=g.tileFlicker.filter(f=>{f.t--;return f.t>0;});
  if(anomalyActive){anomalyData.t--;if(anomalyData.t<=0){anomalyActive=false;}}

  // â”€â”€ Capture zones â”€â”€
  for(const cz of g.captureZones){
    ctx.strokeStyle=`rgba(255,0,68,${0.4*(cz.timer/300)})`;ctx.lineWidth=2;
    ctx.setLineDash([3,3]);
    ctx.beginPath();ctx.arc(sx+cz.x*(CELL+GAP)+CELL/2,sy+cz.y*(CELL+GAP)+CELL/2,(cz.r+0.5)*(CELL+GAP),0,Math.PI*2);ctx.stroke();
    ctx.setLineDash([]);
  }

  // â”€â”€ Containment zones â”€â”€
  for(const cz of g.contZones||[]){
    cz.timer--;
    ctx.strokeStyle=`rgba(0,255,200,${0.4*(cz.timer/200)})`;ctx.lineWidth=2;
    ctx.setLineDash([4,4]);
    ctx.beginPath();ctx.arc(sx+cz.x*(CELL+GAP)+CELL/2,sy+cz.y*(CELL+GAP)+CELL/2,CELL*1.2,0,Math.PI*2);ctx.stroke();
    ctx.setLineDash([]);
  }
  if(g.contZones) g.contZones=g.contZones.filter(c=>c.timer>0);

  // â”€â”€ Echos (afterimages) â”€â”€
  for(const e of g.echos){
    ctx.globalAlpha=e.life/e.maxLife*0.55;
    ctx.fillStyle=e.color;
    ctx.beginPath();ctx.arc(sx+e.x,sy+e.y,e.size*(e.life/e.maxLife),0,Math.PI*2);ctx.fill();
    e.life--;
  }
  g.echos=g.echos.filter(e=>e.life>0);ctx.globalAlpha=1;

  // â”€â”€ Trail â”€â”€
  if(CFG.particles){
    for(const t of g.trail){
      ctx.globalAlpha=(t.life/t.maxLife)*0.48;
      ctx.fillStyle=t.color;ctx.shadowColor=t.color;ctx.shadowBlur=4;
      ctx.beginPath();ctx.arc(sx+t.x,sy+t.y,4*(t.life/t.maxLife),0,Math.PI*2);ctx.fill();
      t.life--;
    }
    g.trail=g.trail.filter(t=>t.life>0);ctx.globalAlpha=1;ctx.shadowBlur=0;
  }

  // â”€â”€ Hallucinations â”€â”€
  for(const h of hallucinations){
    if(h.life<=0) continue;
    const px=sx+h.x*(CELL+GAP),py=sy+h.y*(CELL+GAP);
    const fade=0.3+0.25*Math.sin(Date.now()*0.006+h.x);
    ctx.globalAlpha=fade;
    ctx.fillStyle='#220044';ctx.shadowColor='#8800ff';ctx.shadowBlur=10;
    ctx.beginPath();ctx.roundRect(px+8,py+8,CELL-16,CELL-16,4);ctx.fill();
    ctx.fillStyle='rgba(170,0,255,0.6)';ctx.font='16px Courier New';ctx.textAlign='center';
    ctx.fillText('?',px+CELL/2,py+CELL/2+5);
    ctx.shadowBlur=0;ctx.globalAlpha=1;ctx.textAlign='left';
  }

  // â”€â”€ Enemies â”€â”€
  for(const e of g.enemies){
    const px=sx+e.x*(CELL+GAP),py=sy+e.y*(CELL+GAP);
    const pulse=0.6+0.4*Math.sin(ts*0.007+e.x*1.3);
    const stunned=e.stunTimer>0;
    const isRush=e.type==='rush';
    const eGlow=stunned?'#8888ff':isRush?'#ff0066':(matrixActive==='A'?'#ff0044':'#ff4400');
    ctx.shadowColor=eGlow;ctx.shadowBlur=14*pulse;
    ctx.fillStyle=stunned?'#1c1c44':isRush?'#4a0022':(matrixActive==='A'?'#660022':'#aa2200');
    ctx.beginPath();ctx.roundRect(px+5,py+5,CELL-10,CELL-10,6);ctx.fill();ctx.shadowBlur=0;
    ctx.fillStyle=stunned?'#4444aa':isRush?'#ff0066':(matrixActive==='A'?'#ff2266':'#ff6622');
    ctx.beginPath();ctx.moveTo(px+CELL/2,py+12);ctx.lineTo(px+CELL-12,py+CELL-12);ctx.lineTo(px+12,py+CELL-12);ctx.closePath();ctx.fill();
    ctx.fillStyle=stunned?'#6666cc':'#ffcc00';
    ctx.beginPath();ctx.arc(px+CELL/2,py+CELL/2+2,4,0,Math.PI*2);ctx.fill();
  }

  // â”€â”€ Boss â”€â”€
  if(g.boss&&g.boss.hp>0){
    const b=g.boss;
    const px=sx+b.x*(CELL+GAP),py=sy+b.y*(CELL+GAP);
    const pulse=0.5+0.5*Math.sin(ts*0.005);
    ctx.shadowColor='#ff00aa';ctx.shadowBlur=28*pulse;
    ctx.fillStyle='#330022';
    ctx.beginPath();ctx.roundRect(px+1,py+1,CELL-2,CELL-2,8);ctx.fill();
    ctx.fillStyle='#ff00aa';
    ctx.beginPath();ctx.arc(px+CELL/2,py+CELL/2,CELL*0.3+4*pulse,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#ffccee';ctx.font='bold 10px Courier New';ctx.textAlign='center';
    ctx.fillText('HP:'+b.hp,px+CELL/2,py+CELL/2+4);
    ctx.textAlign='left';ctx.shadowBlur=0;
  }

  // â”€â”€ Player (FIXED WHITE/CYAN IDENTITY) â”€â”€
  {
    const px=sx+g.player.x*(CELL+GAP),py=sy+g.player.y*(CELL+GAP);
    const pulse=0.55+0.45*Math.sin(ts*0.009);
    const shld=UPG.shield&&UPG.shieldTimer>0;
    const phase_=UPG.phaseShift&&UPG.phaseTimer>0;
    
    // Fixed cyan glow (never changes)
    const pGlow='#00e5ff';
    ctx.shadowColor=pGlow;ctx.shadowBlur=(shld?36:(UPG.aura?30:22))*pulse;
    
    // WHITE CORE (always)
    ctx.fillStyle='#ffffff';
    ctx.beginPath();ctx.arc(px+CELL/2,py+CELL/2,CELL/2.5,0,Math.PI*2);ctx.fill();
    
    // CYAN OUTLINE (always)
    ctx.strokeStyle='#00e5ff';ctx.lineWidth=2;
    ctx.beginPath();ctx.arc(px+CELL/2,py+CELL/2,CELL/2.5,0,Math.PI*2);ctx.stroke();
    
    // Archetype active glow
    if(g.archetypeActive){
      const arch=ARCHETYPES[g.archetypeType||'orb'];
      ctx.strokeStyle=arch.glow;ctx.lineWidth=2;ctx.shadowColor=arch.glow;ctx.shadowBlur=16;
      ctx.beginPath();ctx.arc(px+CELL/2,py+CELL/2,CELL/2+4,0,Math.PI*2);ctx.stroke();
    }
    if(shld){ctx.strokeStyle='rgba(0,255,255,0.75)';ctx.lineWidth=2;
      ctx.beginPath();ctx.roundRect(px,py,CELL,CELL,8);ctx.stroke();}
    if(phase_){ctx.globalAlpha=0.4;}  // semi-transparent during phase
    if(UPG.aura){
      ctx.strokeStyle=`rgba(0,255,136,${0.12+0.08*pulse})`;ctx.lineWidth=3;
      ctx.beginPath();ctx.arc(px+CELL/2,py+CELL/2,(CELL/2+7)*pulse,0,Math.PI*2);ctx.stroke();
    }
    ctx.globalAlpha=1;ctx.shadowBlur=0;
    ctx.strokeStyle=pGlow;ctx.lineWidth=2;
    const bk=9;
    [[px,py],[px+CELL,py],[px,py+CELL],[px+CELL,py+CELL]].forEach(([bx,by],i)=>{
      const ddx=i%2===0?1:-1,ddy=i<2?1:-1;
      ctx.beginPath();ctx.moveTo(bx+ddx*2,by);ctx.lineTo(bx+ddx*(2+bk),by);ctx.stroke();
      ctx.beginPath();ctx.moveTo(bx,by+ddy*2);ctx.lineTo(bx,by+ddy*(2+bk));ctx.stroke();
    });
    ctx.shadowBlur=0;
  }

  // â”€â”€ Particles â”€â”€
  if(CFG.particles){
    game.particles=game.particles.filter(p=>p.life>0);
    for(const p of game.particles){
      ctx.globalAlpha=Math.max(0,p.life/p.maxLife);
      ctx.fillStyle=p.color;ctx.shadowColor=p.color;ctx.shadowBlur=7;
      ctx.beginPath();ctx.arc(sx+p.x,sy+p.y,p.r*(p.life/p.maxLife),0,Math.PI*2);ctx.fill();
      p.x+=p.vx;p.y+=p.vy;p.vy+=0.25;p.life--;
    }
    ctx.globalAlpha=1;ctx.shadowBlur=0;
  }

  // â”€â”€ Resonance wave â”€â”€
  if(g.resonanceWave){
    const rw=g.resonanceWave;
    rw.r+=7;rw.alpha=Math.max(0,rw.alpha-(0.55/rw.maxR)*7);
    ctx.strokeStyle=rw.color;ctx.globalAlpha=rw.alpha;ctx.lineWidth=2;
    ctx.shadowColor=rw.color;ctx.shadowBlur=10;
    ctx.beginPath();ctx.arc(sx+rw.x,sy+rw.y,rw.r,0,Math.PI*2);ctx.stroke();
    ctx.globalAlpha=1;ctx.shadowBlur=0;
    if(rw.r>=rw.maxR) g.resonanceWave=null;
  }

  // â”€â”€ Flash â”€â”€
  if(g.flashAlpha>0){
    ctx.fillStyle=g.flashColor;ctx.globalAlpha=g.flashAlpha;
    ctx.fillRect(sx,sy,gp,gp);ctx.globalAlpha=1;
    g.flashAlpha=Math.max(0,g.flashAlpha-0.04);
  }

  // â”€â”€ Matrix A vignette â”€â”€
  if(matrixActive==='A'){
    const vg=ctx.createRadialGradient(w/2,h/2,h*0.25,w/2,h/2,h*0.9);
    vg.addColorStop(0,'rgba(80,0,20,0)');vg.addColorStop(1,'rgba(80,0,20,0.22)');
    ctx.fillStyle=vg;ctx.fillRect(0,0,w,h);
  }

  // â•â•â•â•â•â•â• HUD â•â•â•â•â•â•â•
  const hudH=92;
  ctx.fillStyle='#070714';ctx.fillRect(0,0,w,hudH);
  ctx.strokeStyle='rgba(255,255,255,0.04)';ctx.lineWidth=1;
  ctx.beginPath();ctx.moveTo(0,hudH);ctx.lineTo(w,hudH);ctx.stroke();

  // Dreamscape name bar
  ctx.fillStyle=ds.bgAccent+'88';ctx.fillRect(0,0,w,16);
  ctx.fillStyle='#334455';ctx.font='8px Courier New';ctx.textAlign='center';
  ctx.fillText(ds.name+'  Â·  '+ds.emotion,w/2,11);ctx.textAlign='left';

  // HP
  const hpBarW=138;
  ctx.fillStyle='#333';ctx.font='9px Courier New';ctx.fillText('HP',14,30);
  ctx.fillStyle='#0e0e1e';ctx.fillRect(32,20,hpBarW,13);
  const hpPct=g.hp/UPG.maxHp;
  const hpC=hpPct>0.6?'#00ff88':hpPct>0.3?'#ffaa00':'#ff3333';
  ctx.fillStyle=hpC;ctx.shadowColor=hpC;ctx.shadowBlur=5;ctx.fillRect(32,20,hpBarW*hpPct,13);
  ctx.shadowBlur=0;ctx.strokeStyle='rgba(255,255,255,0.06)';ctx.strokeRect(32,20,hpBarW,13);
  ctx.fillStyle='#444';ctx.font='8px Courier New';ctx.fillText(g.hp+'/'+UPG.maxHp,32+hpBarW+4,30);

  // Energy
  ctx.fillStyle='#222';ctx.font='8px Courier New';ctx.fillText('EN',14,50);
  const eBarW=138;
  ctx.fillStyle='#0a0a1a';ctx.fillRect(32,41,eBarW,9);
  const eC=matrixActive==='A'?'#ff0055':'#0088ff';
  ctx.fillStyle=eC;ctx.shadowColor=eC;ctx.shadowBlur=4;ctx.fillRect(32,41,eBarW*(UPG.energy/UPG.energyMax),9);
  ctx.shadowBlur=0;ctx.strokeStyle='rgba(255,255,255,0.04)';ctx.strokeRect(32,41,eBarW,9);

  // Glitch pulse charge
  if(UPG.glitchPulse){
    ctx.fillStyle='#220a22';ctx.fillRect(32,53,eBarW,6);
    const pChr=UPG.glitchPulseCharge/100;
    const pC=pChr>=1?'#ff00ff':'#660088';
    ctx.fillStyle=pC;ctx.fillRect(32,53,eBarW*pChr,6);
    ctx.strokeStyle='rgba(150,0,200,0.2)';ctx.strokeRect(32,53,eBarW,6);
    ctx.fillStyle=pChr>=1?'#ff00ff':'#553355';ctx.font='7px Courier New';ctx.fillText('PULSE'+(pChr>=1?' READY':''),32+eBarW+4,59);
  }

  // Archetype indicator
  if(g.archetypeActive&&g.archetypeType){
    const arch=ARCHETYPES[g.archetypeType];
    ctx.fillStyle=arch.glow;ctx.shadowColor=arch.glow;ctx.shadowBlur=8;
    ctx.font='8px Courier New';ctx.fillText(arch.powerDesc,14,68);
    ctx.shadowBlur=0;
  } else if(UPG.shield&&UPG.shieldTimer>0){
    ctx.fillStyle='#00ffff';ctx.font='8px Courier New';ctx.fillText('SHIELDÃ—'+UPG.shieldTimer,14,68);
  } else if(UPG.shieldCount>0){
    ctx.fillStyle='#334455';ctx.font='8px Courier New';ctx.fillText('streak '+UPG.shieldCount+'/3',14,68);
  }

  // Combo / resonance
  if(UPG.comboCount>1){
    ctx.fillStyle='#ffcc00';ctx.shadowColor='#ffcc00';ctx.shadowBlur=6;
    ctx.font='8px Courier New';ctx.fillText('COMBO Ã—'+UPG.resonanceMultiplier.toFixed(1),14,80);
    ctx.shadowBlur=0;
  }

  // Tokens
  ctx.fillStyle='#00eeff';ctx.shadowColor='#00eeff';ctx.shadowBlur=5;
  ctx.font='9px Courier New';ctx.fillText('â—†Ã—'+insightTokens,14,90);ctx.shadowBlur=0;

  // Score
  ctx.fillStyle='#00ff88';ctx.shadowColor='#00ff88';ctx.shadowBlur=10;
  ctx.font='bold 19px Courier New';ctx.textAlign='center';
  ctx.fillText(String(g.score).padStart(7,'0'),w/2,38);ctx.shadowBlur=0;
  ctx.fillStyle='#222838';ctx.font='8px Courier New';ctx.fillText('SCORE',w/2,52);

  // Matrix
  const mC=matrixActive==='A'?'#ff0055':'#00aa55';
  ctx.fillStyle=mC;ctx.shadowColor=mC;ctx.shadowBlur=7;
  ctx.font='bold 10px Courier New';ctx.fillText('MTXÂ·'+matrixActive,w/2-16,68);ctx.shadowBlur=0;

  // Right: level / peace / dreamscape progress
  ctx.textAlign='right';
  ctx.fillStyle='#445566';ctx.font='10px Courier New';ctx.fillText('LVL '+g.level,w-12,30);
  ctx.fillStyle='#005533';ctx.fillText('â—ˆÃ—'+g.peaceLeft,w-12,44);
  ctx.fillStyle='#223344';ctx.font='8px Courier New';
  ctx.fillText((CFG.dreamIdx+1)+'/'+DREAMSCAPES.length+' DREAMS',w-12,58);
  ctx.fillStyle=(sessionRep>=0?'#225533':'#442211');
  ctx.fillText('REP '+(sessionRep>=0?'+':'')+sessionRep,w-12,72);
  ctx.textAlign='left';

  // â”€â”€ Message popup â”€â”€
  if(g.msg&&g.msgTimer>0){
    ctx.globalAlpha=Math.min(1,g.msgTimer/18);
    ctx.font='bold 16px Courier New';ctx.textAlign='center';
    ctx.fillStyle=g.msgColor;ctx.shadowColor=g.msgColor;ctx.shadowBlur=16;
    ctx.fillText(g.msg,w/2,sy-16);
    ctx.textAlign='left';ctx.globalAlpha=1;ctx.shadowBlur=0;
    g.msgTimer--;
  }

  // â”€â”€ Footer â”€â”€
  ctx.fillStyle='#070714';ctx.fillRect(0,h-28,w,28);
  ctx.strokeStyle='rgba(255,255,255,0.03)';
  ctx.beginPath();ctx.moveTo(0,h-28);ctx.lineTo(w,h-28);ctx.stroke();
  ctx.fillStyle='#1a1a2a';ctx.font='8px Courier New';ctx.textAlign='center';
  ctx.fillText('WASD/ARROWS Â· SHIFT=matrix Â· ESC=pause Â· J=arch Â· R=pulse Â· Q=freeze Â· C=contain',w/2,h-11);
  ctx.textAlign='left';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SCREENS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawTitle(){
  const w=CW(),h=CH();
  ctx.fillStyle='#02020a';ctx.fillRect(0,0,w,h);
  for(let y=0;y<h;y+=4){ctx.fillStyle='rgba(0,0,0,0.1)';ctx.fillRect(0,y,w,1);}
  if(backgroundStars.length===0) initStars(w,h);
  for(const s of backgroundStars){
    ctx.globalAlpha=s.a*(0.5+0.5*Math.sin(Date.now()*0.0008+s.phase));
    ctx.fillStyle='#ffffff';ctx.beginPath();ctx.arc(s.x,s.y,s.r,0,Math.PI*2);ctx.fill();
  }
  ctx.globalAlpha=1;
  ctx.textAlign='center';
  ctx.fillStyle='#0a0a20';ctx.font='8px Courier New';ctx.fillText('A BEING NAVIGATES THE DREAMSCAPES',w/2,h/2-140);
  ctx.fillStyle='#00ff88';ctx.shadowColor='#00ff88';ctx.shadowBlur=32;
  ctx.font='bold 36px Courier New';ctx.fillText('GLITCHÂ·PEACE',w/2,h/2-100);ctx.shadowBlur=0;
  ctx.fillStyle='#0a1a0a';ctx.font='9px Courier New';ctx.fillText('v5 COMPLETE  Â·  full consciousness simulation + pattern training',w/2,h/2-78);

  const menuTop=h/2-55;
  MAIN_MENU.forEach((opt,i)=>{
    const sel=i===menuIdx;
    const y=menuTop+i*36;
    if(sel){ctx.fillStyle='rgba(0,255,136,0.07)';ctx.fillRect(w/2-130,y-19,260,28);
      ctx.strokeStyle='rgba(0,255,136,0.28)';ctx.strokeRect(w/2-130,y-19,260,28);}
    ctx.fillStyle=sel?'#00ff88':'#2a3a2a';
    ctx.shadowColor=sel?'#00ff88':'transparent';ctx.shadowBlur=sel?8:0;
    ctx.font=sel?'bold 14px Courier New':'12px Courier New';
    ctx.fillText(opt,w/2,y);ctx.shadowBlur=0;
  });
  ctx.fillStyle='#131328';ctx.font='8px Courier New';
  ctx.fillText('â†‘â†“ navigate  Â·  ENTER select',w/2,h-20);ctx.textAlign='left';
}

function drawDreamSelect(){
  const w=CW(),h=CH();
  ctx.fillStyle='#02020a';ctx.fillRect(0,0,w,h);
  ctx.textAlign='center';
  ctx.fillStyle='#00ff88';ctx.shadowColor='#00ff88';ctx.shadowBlur=18;
  ctx.font='bold 20px Courier New';ctx.fillText('SELECT DREAMSCAPE',w/2,50);ctx.shadowBlur=0;
  ctx.fillStyle='#223322';ctx.font='9px Courier New';ctx.fillText('journey begins from your chosen entry point',w/2,68);

  const visible=Math.min(DREAMSCAPES.length,6);
  const startI=Math.max(0,Math.min(CFG.dreamIdx-(Math.floor(visible/2)),DREAMSCAPES.length-visible));
  for(let i=0;i<visible;i++){
    const di=startI+i;
    const ds=DREAMSCAPES[di];
    const sel=di===CFG.dreamIdx;
    const y=95+i*55;
    if(sel){ctx.fillStyle='rgba(0,255,136,0.06)';ctx.fillRect(w/2-160,y-18,320,46);
      ctx.strokeStyle='rgba(0,255,136,0.25)';ctx.strokeRect(w/2-160,y-18,320,46);}
    ctx.fillStyle=sel?'#00ff88':'#2a3a2a';
    ctx.font=sel?'bold 12px Courier New':'11px Courier New';
    ctx.fillText((di+1)+'.  '+ds.name,w/2,y);
    ctx.fillStyle=sel?'#334455':'#1a2a1a';ctx.font='9px Courier New';
    ctx.fillText(ds.subtitle+'  Â·  '+ds.emotion,w/2,y+16);
    if(sel&&ds.archetype){
      const arch=ARCHETYPES[ds.archetype];
      if(arch){ctx.fillStyle='#665522';ctx.fillText('archetype: '+arch.name+' â€” '+arch.powerDesc,w/2,y+30);}
    }
  }
  ctx.fillStyle='#131328';ctx.font='8px Courier New';
  ctx.fillText('â†‘â†“ select  Â·  ENTER start here  Â·  ESC back',w/2,h-20);ctx.textAlign='left';
}

function drawOptions(){
  const w=CW(),h=CH();
  ctx.fillStyle='#02020a';ctx.fillRect(0,0,w,h);
  ctx.textAlign='center';
  ctx.fillStyle='#00ff88';ctx.shadowColor='#00ff88';ctx.shadowBlur=16;
  ctx.font='bold 20px Courier New';ctx.fillText('OPTIONS',w/2,50);ctx.shadowBlur=0;
  const rows=[
    {label:'GRID SIZE',opts:OPT_GRID,cur:CFG.gridSize},
    {label:'DIFFICULTY',opts:OPT_DIFF,cur:CFG.difficulty},
    {label:'PARTICLES',opts:['on','off'],cur:CFG.particles?'on':'off'},
    {label:'',opts:['â† BACK'],cur:'â† BACK'},
  ];
  rows.forEach((row,i)=>{
    const sel=i===optIdx,baseY=105+i*68;
    if(row.label){ctx.fillStyle='#334455';ctx.font='9px Courier New';ctx.fillText(row.label,w/2,baseY);}
    row.opts.forEach((opt,j)=>{
      const active=opt===row.cur;
      const ox=w/2+(j-(row.opts.length-1)/2)*110,oy=baseY+24;
      ctx.fillStyle=(sel&&active)?'rgba(0,255,136,0.12)':'rgba(255,255,255,0.02)';
      ctx.fillRect(ox-44,oy-16,88,24);
      ctx.strokeStyle=(sel&&active)?'rgba(0,255,136,0.5)':active?'rgba(0,255,136,0.18)':'rgba(255,255,255,0.04)';
      ctx.strokeRect(ox-44,oy-16,88,24);
      ctx.fillStyle=active?'#00ff88':'#334455';
      ctx.shadowColor=active?'#00ff88':'transparent';ctx.shadowBlur=active?5:0;
      ctx.font=active?'bold 11px Courier New':'10px Courier New';
      ctx.fillText(opt.toUpperCase(),ox,oy);ctx.shadowBlur=0;
    });
    if(sel){ctx.fillStyle='#00ff88';ctx.font='12px Courier New';ctx.fillText('â–¶',w/2-154,baseY+24);}
  });
  ctx.fillStyle='#131328';ctx.font='8px Courier New';
  ctx.fillText('â†‘â†“ row  Â·  â†â†’ value  Â·  ENTER/ESC back',w/2,h-20);ctx.textAlign='left';
}

function drawPlayMode(){
  const w=CW(),h=CH();
  ctx.fillStyle='#02020a';ctx.fillRect(0,0,w,h);
  for(let y=0;y<h;y+=4){ctx.fillStyle='rgba(0,0,0,0.1)';ctx.fillRect(0,y,w,1);}
  ctx.textAlign='center';
  ctx.fillStyle='#00ff88';ctx.shadowColor='#00ff88';ctx.shadowBlur=20;
  ctx.font='bold 22px Courier New';ctx.fillText('ğŸ® SELECT PLAY MODE',w/2,50);ctx.shadowBlur=0;
  ctx.fillStyle='#223344';ctx.font='9px Courier New';ctx.fillText('13 different ways to play â€” choose your experience',w/2,68);
  
  const modes = Object.keys(PLAY_MODES);
  const visible = Math.min(modes.length, 6);
  const curIdx = modes.indexOf(currentMode);
  const startI = Math.max(0, Math.min(curIdx - Math.floor(visible/2), modes.length - visible));
  
  for(let i=0; i<visible; i++){
    const modeKey = modes[startI + i];
    const mode = PLAY_MODES[modeKey];
    const sel = modeKey === currentMode;
    const y = 105 + i * 62;
    
    if(sel){
      ctx.fillStyle='rgba(0,255,136,0.08)';
      ctx.fillRect(w/2-190, y-20, 380, 52);
      ctx.strokeStyle='rgba(0,255,136,0.3)';
      ctx.lineWidth=2;
      ctx.strokeRect(w/2-190, y-20, 380, 52);
    }
    
    ctx.fillStyle = sel ? '#00ff88' : '#334455';
    ctx.shadowColor = sel ? '#00ff88' : 'transparent';
    ctx.shadowBlur = sel ? 8 : 0;
    ctx.font = sel ? 'bold 14px Courier New' : '12px Courier New';
    ctx.fillText(mode.name.toUpperCase(), w/2, y);
    ctx.shadowBlur = 0;
    
    if(sel){
      ctx.fillStyle='#445566';
      ctx.font='9px Courier New';
      let desc = `PeaceÃ—${mode.peace} HazardÃ—${mode.haz} InsightÃ—${mode.ins} ScoreÃ—${mode.score}`;
      if(mode.special) desc += ` â€¢ ${mode.special}`;
      ctx.fillText(desc, w/2, y+16);
      
      // Show mode-specific info
      let info = '';
      if(mode.special === 'noEnemies') info = 'Peaceful - No threats';
      else if(mode.special === 'timer') info = 'Race against time';
      else if(mode.special === 'moveLimit') info = `Only ${mode.moves} moves`;
      else if(mode.special === 'permadeath') info = `Vision: ${mode.vision} tiles`;
      else if(mode.special === 'recoveryTools') info = 'Pattern training active';
      else if(mode.special === 'bossOnly') info = 'Boss every level';
      else if(mode.special === 'noCombat') info = 'Stealth required';
      else if(mode.special === 'reversed') info = 'Peace hurts, Hazards heal';
      else if(mode.special === 'slowmo') info = 'Ceremonial pacing';
      
      if(info){
        ctx.fillStyle='#556677';
        ctx.font='8px Courier New';
        ctx.fillText(info, w/2, y+28);
      }
    }
  }
  
  ctx.fillStyle='#00ff88';
  ctx.font='14px Courier New';
  ctx.fillText('â–¶', w/2-210, 105 + (curIdx - startI) * 62);
  
  ctx.fillStyle='#131328';
  ctx.font='8px Courier New';
  ctx.fillText('â†‘â†“ select  Â·  ENTER confirm  Â·  ESC back', w/2, h-20);
  ctx.textAlign='left';
}

function drawHighScores(){
  const w=CW(),h=CH();
  ctx.fillStyle='#02020a';ctx.fillRect(0,0,w,h);
  ctx.textAlign='center';
  ctx.fillStyle='#00ff88';ctx.shadowColor='#00ff88';ctx.shadowBlur=16;
  ctx.font='bold 20px Courier New';ctx.fillText('HIGH SCORES',w/2,50);ctx.shadowBlur=0;
  if(highScores.length===0){ctx.fillStyle='#223322';ctx.font='12px Courier New';ctx.fillText('no scores yetâ€¦',w/2,h/2);}
  else{
    highScores.slice(0,8).forEach((s,i)=>{
      const y=95+i*38;
      const med=i===0?'â—ˆ':i===1?'â—‡':'Â·';
      ctx.fillStyle=i===0?'#ffdd00':i===1?'#aaaaaa':i===2?'#cc8833':'#334455';
      ctx.font=i<3?'bold 12px Courier New':'11px Courier New';
      ctx.fillText(`${med}  ${String(s.score).padStart(7,'0')}   LVL${String(s.level).padStart(2,'0')}   ${s.dreamscape}   ${s.date}`,w/2,y);
    });
  }
  ctx.fillStyle='#131328';ctx.font='8px Courier New';
  ctx.fillText('ENTER / ESC back',w/2,h-20);ctx.textAlign='left';
}

function drawUpgradeShop(){
  const w=CW(),h=CH();
  ctx.fillStyle='#02020a';ctx.fillRect(0,0,w,h);
  ctx.textAlign='center';
  ctx.fillStyle='#00eeff';ctx.shadowColor='#00eeff';ctx.shadowBlur=16;
  ctx.font='bold 20px Courier New';ctx.fillText('UPGRADES',w/2,50);ctx.shadowBlur=0;
  ctx.fillStyle='#334455';ctx.font='10px Courier New';ctx.fillText('â—† insight tokens: '+insightTokens,w/2,68);
  UPGRADE_SHOP.forEach((up,i)=>{
    const sel=i===shopIdx,owned=checkOwned(up.id);
    const canBuy=insightTokens>=up.cost&&!owned;
    const y=92+i*48;
    if(sel){ctx.fillStyle='rgba(0,238,255,0.06)';ctx.fillRect(w/2-155,y-14,310,40);
      ctx.strokeStyle='rgba(0,238,255,0.22)';ctx.strokeRect(w/2-155,y-14,310,40);}
    ctx.fillStyle=owned?'#00ff88':canBuy?'#00ccdd':'#334455';
    ctx.shadowColor=owned?'#00ff88':sel?'#00ccdd':'transparent';ctx.shadowBlur=(sel&&!owned)?5:0;
    ctx.font='bold 11px Courier New';ctx.fillText(up.name,w/2-55,y);ctx.shadowBlur=0;
    ctx.fillStyle='#334';ctx.font='9px Courier New';ctx.fillText(up.desc,w/2-55,y+14);
    ctx.fillStyle=owned?'#005533':canBuy?'#006677':'#221122';
    ctx.font='10px Courier New';ctx.fillText(owned?'OWNED':'â—†Ã—'+up.cost,w/2+88,y+4);
  });
  ctx.fillStyle='#131328';ctx.font='8px Courier New';
  ctx.fillText('â†‘â†“ select  Â·  ENTER buy  Â·  ESC back',w/2,h-20);ctx.textAlign='left';
}

function drawPause(){
  const w=CW(),h=CH();
  ctx.fillStyle='rgba(0,0,0,0.87)';ctx.fillRect(0,0,w,h);
  ctx.textAlign='center';
  ctx.fillStyle='#00ff88';ctx.shadowColor='#00ff88';ctx.shadowBlur=14;
  ctx.font='bold 24px Courier New';ctx.fillText('PAUSED',w/2,h/2-80);ctx.shadowBlur=0;
  if(game){
    ctx.fillStyle='#223322';ctx.font='9px Courier New';
    ctx.fillText(game.ds.name+'  Â·  LEVEL '+game.level,w/2,h/2-58);
    ctx.fillStyle='#334455';ctx.fillText(game.ds.narrative,w/2,h/2-44);
  }
  PAUSE_MENU.forEach((txt,i)=>{
    const sel=i===pauseIdx,y=h/2-14+i*36;
    if(sel){ctx.fillStyle='rgba(0,255,136,0.07)';ctx.fillRect(w/2-110,y-18,220,26);
      ctx.strokeStyle='rgba(0,255,136,0.26)';ctx.strokeRect(w/2-110,y-18,220,26);}
    ctx.fillStyle=sel?'#00ff88':'#334433';ctx.shadowColor=sel?'#00ff88':'transparent';ctx.shadowBlur=sel?6:0;
    ctx.font=sel?'bold 13px Courier New':'12px Courier New';ctx.fillText(txt,w/2,y);ctx.shadowBlur=0;
  });
  ctx.fillStyle='#131328';ctx.font='8px Courier New';
  ctx.fillText('â†‘â†“ navigate  Â·  ENTER select  Â·  ESC resume',w/2,h-20);ctx.textAlign='left';
}

function drawInterlude(ts){
  const w=CW(),h=CH();
  const prog=1-(interludeState.timer/220);
  const alpha=prog<0.1?prog/0.1:prog>0.9?(1-prog)/0.1:1;
  const ds=interludeState.ds||DREAMSCAPES[0];
  ctx.fillStyle=ds.bgColor||'#02020a';ctx.fillRect(0,0,w,h);
  for(let i=0;i<7;i++){
    const lx=(ts*0.02+i*w/7)%w;
    ctx.strokeStyle=`rgba(0,255,136,${0.02*alpha})`;ctx.lineWidth=1;
    ctx.beginPath();ctx.moveTo(lx,0);ctx.lineTo(lx-100,h);ctx.stroke();
  }
  ctx.globalAlpha=alpha;ctx.textAlign='center';
  ctx.fillStyle='#00ff88';ctx.shadowColor='#00ff88';ctx.shadowBlur=20;
  ctx.font='bold 14px Courier New';ctx.fillText(interludeState.text,w/2,h/2-28);ctx.shadowBlur=0;
  ctx.fillStyle='#223322';ctx.font='11px Courier New';ctx.fillText('ENTERING: '+ds.name,w/2,h/2+4);
  ctx.fillStyle='#334455';ctx.font='10px Courier New';ctx.fillText(ds.narrative,w/2,h/2+24);
  if(ds.archetype&&ARCHETYPES[ds.archetype]){
    const arch=ARCHETYPES[ds.archetype];
    ctx.fillStyle=arch.glow;ctx.shadowColor=arch.glow;ctx.shadowBlur=10;
    ctx.font='10px Courier New';ctx.fillText('archetype: '+arch.name,w/2,h/2+46);ctx.shadowBlur=0;
  }
  ctx.globalAlpha=1;ctx.textAlign='left';
  interludeState.timer--;
  if(interludeState.timer<=0&&phase==='interlude') phase='playing';
}

function drawDead(){
  const w=CW(),h=CH();
  ctx.fillStyle='rgba(8,0,0,0.97)';ctx.fillRect(0,0,w,h);
  ctx.textAlign='center';
  const ds=game?.ds;
  ctx.fillStyle='#330000';ctx.font='9px Courier New';
  ctx.fillText('THE BEING DISSOLVES IN '+(ds?.name||'THE VOID'),w/2,h/2-138);
  ctx.fillStyle='#ff2222';ctx.shadowColor='#ff2222';ctx.shadowBlur=30;
  ctx.font='bold 40px Courier New';ctx.fillText('ERASED',w/2,h/2-90);ctx.shadowBlur=0;
  ctx.fillStyle='#00ff88';ctx.shadowColor='#00ff88';ctx.shadowBlur=10;
  ctx.font='bold 26px Courier New';ctx.fillText(String(game.score).padStart(7,'0'),w/2,h/2-28);ctx.shadowBlur=0;
  ctx.fillStyle='#333';ctx.font='10px Courier New';ctx.fillText('FINAL SCORE  Â·  LEVEL '+game.level,w/2,h/2-6);
  ctx.fillStyle='#223322';ctx.font='9px Courier New';
  ctx.fillText('dreams completed: '+(dreamHistory.length)+'/'+DREAMSCAPES.length,w/2,h/2+14);
  ctx.fillText('REP '+(sessionRep>=0?'+':'')+sessionRep+'  Â·  â—†Ã—'+insightTokens,w/2,h/2+32);
  if(highScores.length>0){
    const rank=highScores.findIndex(s=>s.score===game.score);
    if(rank>=0){ctx.fillStyle='#ffdd00';ctx.font='bold 11px Courier New';ctx.fillText('RANK #'+(rank+1)+' ALL TIME',w/2,h/2+54);}
  }
  const pulse=0.7+0.3*Math.sin(Date.now()*0.004);
  ctx.fillStyle=`rgba(255,34,34,${0.07*pulse})`;ctx.fillRect(w/2-110,h/2+70,220,34);
  ctx.strokeStyle=`rgba(255,34,34,${0.45*pulse})`;ctx.strokeRect(w/2-110,h/2+70,220,34);
  ctx.fillStyle='#ff2222';ctx.font='12px Courier New';ctx.fillText('â†º  ENTER TO TRY AGAIN',w/2,h/2+92);
  ctx.fillStyle='#221122';ctx.font='9px Courier New';ctx.fillText('ESC â†’ TITLE',w/2,h/2+120);
  ctx.textAlign='left';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MAIN LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loop(ts){
  const dt=ts-prevTs; prevTs=ts;

  if(phase==='title')      {drawTitle();animId=requestAnimationFrame(loop);return;}
  if(phase==='playmode')   {drawPlayMode();animId=requestAnimationFrame(loop);return;}
  if(phase==='dreamselect'){drawDreamSelect();animId=requestAnimationFrame(loop);return;}
  if(phase==='options')    {drawOptions();animId=requestAnimationFrame(loop);return;}
  if(phase==='highscores') {drawHighScores();animId=requestAnimationFrame(loop);return;}
  if(phase==='upgrade')    {drawUpgradeShop();animId=requestAnimationFrame(loop);return;}
  if(phase==='dead')       {drawDead();animId=requestAnimationFrame(loop);return;}
  if(phase==='paused')     {drawPause();animId=requestAnimationFrame(loop);return;}
  if(phase==='interlude')  {drawInterlude(ts);animId=requestAnimationFrame(loop);return;}

  // â”€â”€ Playing â”€â”€
  const MOVE_DELAY=game.slowMoves?UPG.moveDelay*1.5:UPG.moveDelay;
  const DIRS={ArrowUp:[-1,0],ArrowDown:[1,0],ArrowLeft:[0,-1],ArrowRight:[0,1],
    w:[-1,0],s:[1,0],a:[0,-1],d:[0,1],W:[-1,0],S:[1,0],A:[0,-1],D:[0,1]};
  if(ts-lastMove>MOVE_DELAY){
    let moved=false;
    for(const [k,[dy,dx]] of Object.entries(DIRS)){
      if(keys.has(k)){tryMove(dy,dx);lastMove=ts;moved=true;break;}
    }
    if(!moved&&UPG.magnet) tryMagnet();
  }

  // Emotion tick
  if(game.emotionTimer>0){game.emotionTimer--;if(game.emotionTimer<=0){game.slowMoves=false;UPG.emotion='neutral';}}

  // Matrix hold effects
  matrixHoldTime+=dt;
  if(matrixActive==='B'&&matrixHoldTime>4000&&Math.random()<0.0002*dt)
    {game.hp=Math.min(UPG.maxHp,game.hp+1);}
  if(matrixActive==='A'&&matrixHoldTime>2500&&Math.random()<0.0003*dt)
    {game.hp=Math.max(0,game.hp-1);}

  // Glitch
  glitchTimer-=dt;
  if(glitchTimer<=0){glitchFrames=2+rnd(4);glitchTimer=500+rnd(700);}

  // Environment event
  game.environmentTimer-=dt;
  if(game.environmentTimer<=0){
    game.environmentTimer=900+rnd(700);
    if(Math.random()<0.6) triggerEnvironmentEvent(game);
  }

  // Tile spread
  stepTileSpread(dt);

  stepEnemies(dt);

  if(game.hp<=0){
    saveScore(game.score,game.level,game.ds);
    phase='dead'; animId=requestAnimationFrame(loop); return;
  }

  draw(ts);
  animId=requestAnimationFrame(loop);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INPUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('keydown',e=>{
  keys.add(e.key);

  if(phase==='title'){
    if(e.key==='ArrowUp')   menuIdx=(menuIdx-1+MAIN_MENU.length)%MAIN_MENU.length;
    if(e.key==='ArrowDown') menuIdx=(menuIdx+1)%MAIN_MENU.length;
    if(e.key==='Enter'||e.key===' '){
      if(menuIdx===0)      startGame(CFG.dreamIdx);
      else if(menuIdx===1) phase='dreamselect';
      else if(menuIdx===2) phase='playmode';
      else if(menuIdx===3){optIdx=0;phase='options';}
      else if(menuIdx===4) phase='highscores';
      else if(menuIdx===5){shopIdx=0;upgradeFrom='title';phase='upgrade';}
    }
    e.preventDefault();return;
  }
  if(phase==='playmode'){
    const modes = Object.keys(PLAY_MODES);
    const curIdx = modes.indexOf(currentMode);
    if(e.key==='ArrowUp')   currentMode = modes[(curIdx-1+modes.length)%modes.length];
    if(e.key==='ArrowDown') currentMode = modes[(curIdx+1)%modes.length];
    if(e.key==='Enter'){
      showMsg('Mode: '+PLAY_MODES[currentMode].name,'#00ff88',80);
      phase='title';
    }
    if(e.key==='Escape')    phase='title';
    e.preventDefault();return;
  }
  if(phase==='dreamselect'){
    if(e.key==='ArrowUp')   CFG.dreamIdx=(CFG.dreamIdx-1+DREAMSCAPES.length)%DREAMSCAPES.length;
    if(e.key==='ArrowDown') CFG.dreamIdx=(CFG.dreamIdx+1)%DREAMSCAPES.length;
    if(e.key==='Enter')     startGame(CFG.dreamIdx);
    if(e.key==='Escape')    phase='title';
    e.preventDefault();return;
  }
  if(phase==='options'){
    if(e.key==='ArrowUp')   optIdx=(optIdx-1+4)%4;
    if(e.key==='ArrowDown') optIdx=(optIdx+1)%4;
    if(e.key==='ArrowLeft'||e.key==='ArrowRight'){
      const dir=e.key==='ArrowLeft'?-1:1;
      if(optIdx===0){const i=OPT_GRID.indexOf(CFG.gridSize);CFG.gridSize=OPT_GRID[(i+dir+3)%3];}
      else if(optIdx===1){const i=OPT_DIFF.indexOf(CFG.difficulty);CFG.difficulty=OPT_DIFF[(i+dir+3)%3];}
      else if(optIdx===2) CFG.particles=!CFG.particles;
    }
    if(e.key==='Enter'||e.key==='Escape'){
      if(optIdx===3||e.key==='Escape') phase=game?'paused':'title';
    }
    e.preventDefault();return;
  }
  if(phase==='highscores'){if(e.key==='Enter'||e.key==='Escape') phase='title';e.preventDefault();return;}
  if(phase==='upgrade'){
    if(e.key==='ArrowUp')   shopIdx=(shopIdx-1+UPGRADE_SHOP.length)%UPGRADE_SHOP.length;
    if(e.key==='ArrowDown') shopIdx=(shopIdx+1)%UPGRADE_SHOP.length;
    if(e.key==='Enter')     buyUpgrade(UPGRADE_SHOP[shopIdx].id);
    if(e.key==='Escape')    phase=upgradeFrom==='paused'?'paused':'title';
    e.preventDefault();return;
  }
  if(phase==='dead'){
    if(e.key==='Enter'||e.key===' ') startGame(CFG.dreamIdx);
    if(e.key==='Escape'){phase='title';menuIdx=0;}
    e.preventDefault();return;
  }
  if(phase==='paused'){
    if(e.key==='ArrowUp')   pauseIdx=(pauseIdx-1+PAUSE_MENU.length)%PAUSE_MENU.length;
    if(e.key==='ArrowDown') pauseIdx=(pauseIdx+1)%PAUSE_MENU.length;
    if(e.key==='Enter'){
      if(pauseIdx===0) phase='playing';
      else if(pauseIdx===1){optIdx=0;phase='options';}
      else if(pauseIdx===2){shopIdx=0;upgradeFrom='paused';phase='upgrade';}
      else{phase='title';menuIdx=0;game=null;}
    }
    if(e.key==='Escape') phase='playing';
    e.preventDefault();return;
  }
  if(phase==='playing'){
    if(e.key==='Escape'){pauseIdx=0;phase='paused';}
    if(e.key==='Shift'&&!e.repeat){
      matrixActive=matrixActive==='A'?'B':'A';matrixHoldTime=0;
      const lbl=matrixActive==='A'?'MATRIXÂ·A  âŸ¨ERASUREâŸ©':'MATRIXÂ·B  âŸ¨COHERENCEâŸ©';
      const col=matrixActive==='A'?'#ff0055':'#00ff88';
      showMsg(lbl,col,55);
      if(CFG.particles){burst(game.player.x,game.player.y,col,22,4);}
      for(let i=0;i<4;i++) addEcho(game);
    }
    // Archetype power / rewind
    if((e.key==='j'||e.key==='J')&&!e.repeat){
      if(game.archetypeActive) executeArchetypePower(game);
      else if(UPG.temporalRewind&&UPG.rewindBuffer.length>0) executeArchetypePower(game);
      else showMsg('NO ARCHETYPE ACTIVE','#334455',25);
    }
    // Glitch pulse
    if((e.key==='r'||e.key==='R')&&!e.repeat){
      if(UPG.glitchPulse&&UPG.glitchPulseCharge>=100) triggerGlitchPulse();
      else if(UPG.glitchPulse) showMsg('CHARGINGâ€¦ '+Math.round(UPG.glitchPulseCharge)+'%','#660088',22);
      else showMsg('BUY GLITCH PULSE IN UPGRADES','#334455',28);
    }
    // Freeze
    if((e.key==='q'||e.key==='Q')&&!e.repeat){
      if(UPG.freeze&&UPG.freezeTimer<=0){UPG.freezeTimer=2500;
        showMsg('FREEZE ACTIVE!','#0088ff',50);burst(game.player.x,game.player.y,'#0088ff',20,4);}
    }
    // Containment zone
    if((e.key==='c'||e.key==='C')&&!e.repeat){
      if(insightTokens>=2){insightTokens-=2;
        if(!game.contZones) game.contZones=[];
        game.contZones.push({x:game.player.x,y:game.player.y,timer:240,maxTimer:240});
        showMsg('CONTAINMENT ZONE','#00ffcc',38);}
      else showMsg('NEED 2 â—† FOR CONTAINMENT','#334455',28);
    }
  }
  const prevent=['ArrowUp','ArrowDown','ArrowLeft','ArrowRight',' '];
  if(prevent.includes(e.key)) e.preventDefault();
});

window.addEventListener('keyup',e=>keys.delete(e.key));

// Mobile
function holdKey(key){keys.add(key);return()=>keys.delete(key);}
function dpadBtn(id,key){
  const btn=document.getElementById(id);if(!btn)return;
  let rel;
  btn.addEventListener('touchstart',e=>{e.preventDefault();rel=holdKey(key);if(phase==='title')startGame(CFG.dreamIdx);},{passive:false});
  btn.addEventListener('touchend',  e=>{e.preventDefault();if(rel)rel();},{passive:false});
  btn.addEventListener('mousedown', ()=>{rel=holdKey(key);if(phase==='title')startGame(CFG.dreamIdx);});
  btn.addEventListener('mouseup',   ()=>{if(rel)rel();});
}
dpadBtn('btn-up','ArrowUp');dpadBtn('btn-down','ArrowDown');
dpadBtn('btn-left','ArrowLeft');dpadBtn('btn-right','ArrowRight');
canvas.addEventListener('click',()=>{if(phase==='title')startGame(CFG.dreamIdx);});

// Boot
animId=requestAnimationFrame(loop);
</script>
</body>
</html>
